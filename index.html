<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MBWD">
    <meta name="theme-color" content="#0d0d0d">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>MBWD App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0d0d0d;
            --bg-secondary: #1a1a1a;
            --bg-card: #242424;
            --bg-input: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent: #c41e3a;
            --accent-glow: rgba(196, 30, 58, 0.3);
            --success: #2ecc71;
            --success-glow: rgba(46, 204, 113, 0.3);
            --blue: #3498db;
            --blue-glow: rgba(52, 152, 219, 0.3);
            --orange: #e67e22;
            --orange-glow: rgba(230, 126, 34, 0.3);
            --purple: #9b59b6;
            --purple-glow: rgba(155, 89, 182, 0.3);
            --teal: #1abc9c;
            --teal-glow: rgba(26, 188, 156, 0.3);
            --border: #333333;
            --radius: 12px;
            --radius-lg: 20px;
            --shadow: 0 4px 24px rgba(0,0,0,0.4);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .screen { display: none; min-height: 100vh; }
        .screen.active { display: block; }
        .login-screen.active { display: flex; }

        /* LOGIN */
        .login-screen { flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; background: var(--bg-primary); }
        .login-logo { width: 100px; height: 100px; background: linear-gradient(135deg, var(--accent) 0%, #8b1528 100%); border-radius: 24px; display: flex; align-items: center; justify-content: center; margin-bottom: 24px; box-shadow: 0 0 60px var(--accent-glow); }
        .login-logo svg { width: 60px; height: 60px; fill: white; }
        .login-title { font-size: 36px; font-weight: 700; margin-bottom: 8px; text-align: center; letter-spacing: -1px; }
        .login-subtitle { font-size: 15px; color: var(--text-secondary); margin-bottom: 48px; text-align: center; }
        .login-card { width: 100%; max-width: 360px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 32px; box-shadow: var(--shadow); }
        .login-field { margin-bottom: 20px; }
        .login-field-label { display: block; font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; text-align: center; }
        .login-input { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 18px; font-weight: 600; color: var(--text-primary); text-align: center; text-transform: uppercase; letter-spacing: 2px; }
        .login-input:focus { outline: none; border-color: var(--accent); }
        .login-input::placeholder { color: var(--text-muted); text-transform: none; letter-spacing: normal; font-weight: 400; }
        .login-error { margin-top: 16px; padding: 12px; background: rgba(231, 76, 60, 0.2); border: 1px solid #e74c3c; border-radius: 8px; color: #e74c3c; font-size: 13px; text-align: center; display: none; }
        .login-error.show { display: block; }
        .pin-label { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 16px; text-align: center; }
        .pin-display { display: flex; justify-content: center; gap: 12px; margin-bottom: 24px; }
        .pin-dot { width: 20px; height: 20px; border-radius: 50%; background: var(--bg-input); border: 2px solid var(--border); transition: var(--transition); }
        .pin-dot.filled { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 12px var(--accent-glow); }
        .pin-dot.error { background: #e74c3c; border-color: #e74c3c; animation: shake 0.5s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 20%, 60% { transform: translateX(-5px); } 40%, 80% { transform: translateX(5px); } }
        .pin-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .pin-key { height: 64px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 600; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .pin-key:active { transform: scale(0.95); background: var(--accent); }
        .pin-key.empty { visibility: hidden; }
        .pin-key svg { width: 24px; height: 24px; fill: var(--text-secondary); }
        /* DASHBOARD */
        .dashboard-screen { background: var(--bg-primary); }
        .dashboard-header { position: sticky; top: 0; z-index: 100; background: rgba(13, 13, 13, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 20px 24px; }
        .dashboard-header-top { display: flex; align-items: center; justify-content: space-between; }
        .dashboard-logo { display: flex; align-items: center; gap: 12px; }
        .dashboard-logo-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .dashboard-logo-icon svg { width: 24px; height: 24px; fill: white; }
        .dashboard-logo-text { font-size: 22px; font-weight: 700; }
        .dashboard-user { display: flex; align-items: center; gap: 12px; }
        .user-badge { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 8px 16px; font-size: 13px; font-weight: 600; color: var(--text-secondary); }
        .user-badge.admin { background: rgba(196, 30, 58, 0.2); border-color: var(--accent); color: var(--accent); }
        .logout-btn { width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .logout-btn:hover { background: var(--bg-input); }
        .logout-btn svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .dashboard-date { font-size: 14px; color: var(--text-muted); margin-top: 12px; }

        /* TILES */
        .tiles-container { padding: 24px; max-width: 1200px; margin: 0 auto; }
        .tiles-section-title { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px; margin-top: 8px; }
        .tiles-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 32px; }
        @media (min-width: 768px) { .tiles-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .tiles-grid { grid-template-columns: repeat(4, 1fr); } }
        .tile { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; cursor: pointer; transition: var(--transition); position: relative; overflow: hidden; }
        .tile:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
        .tile:active { transform: translateY(0); }
        .tile::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; }
        .tile.red::before { background: var(--accent); }
        .tile.green::before { background: var(--success); }
        .tile.blue::before { background: var(--blue); }
        .tile.orange::before { background: var(--orange); }
        .tile.purple::before { background: var(--purple); }
        .tile.teal::before { background: var(--teal); }
        .tile:hover.red { border-color: var(--accent); box-shadow: 0 8px 32px var(--accent-glow); }
        .tile:hover.green { border-color: var(--success); box-shadow: 0 8px 32px var(--success-glow); }
        .tile:hover.blue { border-color: var(--blue); box-shadow: 0 8px 32px var(--blue-glow); }
        .tile:hover.orange { border-color: var(--orange); box-shadow: 0 8px 32px var(--orange-glow); }
        .tile:hover.purple { border-color: var(--purple); box-shadow: 0 8px 32px var(--purple-glow); }
        .tile:hover.teal { border-color: var(--teal); box-shadow: 0 8px 32px var(--teal-glow); }
        .tile-icon { width: 56px; height: 56px; border-radius: 14px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
        .tile.red .tile-icon { background: rgba(196, 30, 58, 0.2); }
        .tile.green .tile-icon { background: rgba(46, 204, 113, 0.2); }
        .tile.blue .tile-icon { background: rgba(52, 152, 219, 0.2); }
        .tile.orange .tile-icon { background: rgba(230, 126, 34, 0.2); }
        .tile.purple .tile-icon { background: rgba(155, 89, 182, 0.2); }
        .tile.teal .tile-icon { background: rgba(26, 188, 156, 0.2); }
        .tile-icon svg { width: 28px; height: 28px; }
        .tile.red .tile-icon svg { fill: var(--accent); }
        .tile.green .tile-icon svg { fill: var(--success); }
        .tile.blue .tile-icon svg { fill: var(--blue); }
        .tile.orange .tile-icon svg { fill: var(--orange); }
        .tile.purple .tile-icon svg { fill: var(--purple); }
        .tile.teal .tile-icon svg { fill: var(--teal); }
        .tile-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .tile-desc { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
        .tile.disabled { opacity: 0.5; cursor: not-allowed; }
        .tile.disabled:hover { transform: none; box-shadow: none; border-color: var(--border); }
        .tile-badge { position: absolute; top: 16px; right: 16px; background: var(--accent); color: white; font-size: 11px; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
        .tile-badge.coming { background: var(--text-muted); }

        /* APP SCREEN (Ambulanzcheck etc) */
        .app-screen { padding-bottom: 120px; }
        .app-header { position: sticky; top: 0; z-index: 100; background: rgba(13, 13, 13, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); padding: 16px 20px; }
        .header-top { display: flex; align-items: center; gap: 16px; margin-bottom: 12px; }
        .back-btn { width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); flex-shrink: 0; }
        .back-btn:hover { background: var(--bg-input); }
        .back-btn svg { width: 20px; height: 20px; fill: var(--text-primary); }
        .header-title { font-size: 20px; font-weight: 700; flex: 1; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .header-btn:hover { background: var(--bg-input); }
        .header-btn svg { width: 20px; height: 20px; fill: var(--text-secondary); }
        .header-meta { display: flex; align-items: center; gap: 16px; font-size: 14px; color: var(--text-secondary); flex-wrap: wrap; }
        .header-date { font-family: 'JetBrains Mono', monospace; background: var(--bg-card); padding: 6px 12px; border-radius: 8px; }
        .employee-input { display: flex; align-items: center; gap: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 6px 12px; flex: 1; max-width: 280px; }
        .employee-input svg { width: 18px; height: 18px; fill: var(--text-muted); flex-shrink: 0; }
        .employee-name-input { background: none; border: none; color: var(--text-primary); font-family: inherit; font-size: 14px; width: 100%; outline: none; }
        .employee-name-input::placeholder { color: var(--text-muted); }
        .progress-bar { height: 4px; background: var(--bg-input); border-radius: 2px; overflow: hidden; margin-top: 12px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 2px; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: var(--text-muted); margin-top: 6px; text-align: right; font-family: 'JetBrains Mono', monospace; }

        /* CHECKLIST */
        .checklist-container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 24px; }
        .section-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius) var(--radius) 0 0; cursor: pointer; transition: var(--transition); }
        .section-header:hover { background: var(--bg-input); }
        .section-icon { width: 40px; height: 40px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .section-icon svg { width: 22px; height: 22px; fill: white; }
        .section-info { flex: 1; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 2px; }
        .section-count { font-size: 13px; color: var(--text-muted); }
        .section-toggle { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; transition: transform 0.3s ease; }
        .section-toggle svg { width: 20px; height: 20px; fill: var(--text-muted); }
        .section.collapsed .section-toggle { transform: rotate(-90deg); }
        .section-content { background: var(--bg-secondary); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius) var(--radius); overflow: hidden; }
        .section.collapsed .section-content { display: none; }
        .check-item { display: flex; flex-direction: column; gap: 8px; padding: 18px 20px; border-bottom: 1px solid var(--border); transition: var(--transition); }
        .check-item:last-child { border-bottom: none; }
        .check-item:active { background: var(--bg-card); }
        .check-item-row { display: flex; align-items: center; gap: 16px; }
        .check-label { flex: 1; font-size: 15px; line-height: 1.4; color: var(--text-primary); }
        .check-label.checked { color: var(--text-secondary); }
        .comment-toggle { width: 32px; height: 32px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); flex-shrink: 0; }
        .comment-toggle:hover { background: var(--border); }
        .comment-toggle.has-comment { background: var(--accent); border-color: var(--accent); }
        .comment-toggle svg { width: 16px; height: 16px; fill: var(--text-muted); }
        .comment-toggle.has-comment svg { fill: white; }
        .doc-link { width: 32px; height: 32px; background: var(--blue); border: 1px solid var(--blue); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); flex-shrink: 0; text-decoration: none; }
        .doc-link:hover { background: #2980b9; transform: scale(1.05); }
        .doc-link:active { transform: scale(0.95); }
        .doc-link svg { width: 16px; height: 16px; fill: white; }
        .comment-field { display: none; width: 100%; }
        .comment-field.show { display: block; }
        .comment-input { width: 100%; padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 14px; resize: none; min-height: 60px; }
        .comment-input:focus { outline: none; border-color: var(--accent); }
        .comment-input::placeholder { color: var(--text-muted); }
        .toggle-switch { position: relative; width: 72px; height: 44px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-input); border: 2px solid var(--border); border-radius: 22px; transition: var(--transition); }
        .toggle-slider:before { position: absolute; content: ""; height: 36px; width: 36px; left: 2px; bottom: 2px; background: white; border-radius: 50%; transition: var(--transition); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .toggle-switch input:checked + .toggle-slider { background: var(--success); border-color: var(--success); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(28px); }
        .sunday-section { background: linear-gradient(135deg, rgba(196, 30, 58, 0.1) 0%, transparent 100%); border: 1px solid var(--accent); border-radius: var(--radius); }
        .sunday-section .section-header { background: rgba(196, 30, 58, 0.1); border-color: var(--accent); }

        /* EXPIRY TRACKER */
        .expiry-tracker { margin: 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .expiry-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; }
        .expiry-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .expiry-title { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .expiry-title svg { width: 24px; height: 24px; fill: var(--orange); }
        .expiry-badge { background: var(--orange); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; }
        .expiry-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
        .expiry-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-input); border-radius: var(--radius); border-left: 4px solid var(--text-muted); }
        .expiry-item.urgent { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }
        .expiry-item.warning { border-left-color: var(--orange); background: rgba(230, 126, 34, 0.1); }
        .expiry-item.soon { border-left-color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
        .expiry-item-info { flex: 1; }
        .expiry-item-name { font-size: 15px; font-weight: 500; margin-bottom: 2px; }
        .expiry-item-date { font-size: 13px; color: var(--text-muted); }
        .expiry-item-meta { font-size: 11px; color: var(--text-muted); margin-top: 4px; }
        .expiry-item-days { font-size: 13px; font-weight: 600; padding: 4px 10px; border-radius: 8px; background: var(--bg-card); white-space: nowrap; }
        .expiry-item.urgent .expiry-item-days { background: #e74c3c; color: white; }
        .expiry-item.warning .expiry-item-days { background: var(--orange); color: white; }
        .expiry-item.soon .expiry-item-days { background: #f1c40f; color: #333; }
        .expiry-delete { width: 32px; height: 32px; background: transparent; border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .expiry-delete:hover { background: #e74c3c; border-color: #e74c3c; }
        .expiry-delete svg { width: 16px; height: 16px; fill: var(--text-muted); }
        .expiry-delete:hover svg { fill: white; }
        .expiry-empty { text-align: center; padding: 24px; color: var(--text-muted); font-size: 14px; }
        .expiry-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .expiry-input { flex: 1; min-width: 150px; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); font-family: inherit; font-size: 14px; }
        .expiry-input:focus { outline: none; border-color: var(--orange); }
        .expiry-input::placeholder { color: var(--text-muted); }
        .expiry-input[type="date"] { min-width: 140px; }
        .expiry-add-btn { padding: 12px 20px; background: var(--orange); border: none; border-radius: var(--radius); color: white; font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: var(--transition); }
        .expiry-add-btn:hover { background: #d35400; }
        .expiry-add-btn svg { width: 18px; height: 18px; fill: white; }

        /* REINIGUNGSPLAN STYLES */
        .reinigung-container { padding: 20px; max-width: 900px; margin: 0 auto; }
        .reinigung-day { margin-bottom: 32px; }
        .reinigung-day-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; background: linear-gradient(135deg, var(--teal) 0%, #148f77 100%); border-radius: var(--radius); margin-bottom: 16px; }
        .reinigung-day-icon { width: 44px; height: 44px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .reinigung-day-icon svg { width: 24px; height: 24px; fill: white; }
        .reinigung-day-name { font-size: 20px; font-weight: 700; color: white; }
        .reinigung-day-count { font-size: 13px; color: rgba(255,255,255,0.8); margin-left: auto; }
        .reinigung-task { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 12px; overflow: hidden; transition: var(--transition); }
        .reinigung-task:hover { border-color: var(--teal); }
        .reinigung-task.completed { border-color: var(--success); }
        .reinigung-task-header { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .reinigung-task.completed .reinigung-task-header { background: rgba(46, 204, 113, 0.1); }
        .schicht-badge { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
        .schicht-badge.si { background: rgba(52, 152, 219, 0.2); color: var(--blue); }
        .schicht-badge.fi { background: rgba(230, 126, 34, 0.2); color: var(--orange); }
        .schicht-badge.di { background: rgba(155, 89, 182, 0.2); color: var(--purple); }
        .schicht-badge.dii { background: rgba(155, 89, 182, 0.2); color: var(--purple); }
        .schicht-badge.sek { background: rgba(149, 165, 166, 0.2); color: #95a5a6; }
        .schicht-badge.bgf { background: rgba(46, 204, 113, 0.2); color: var(--success); }
        .reinigung-bereich { font-size: 16px; font-weight: 600; flex: 1; }
        .reinigung-info-btn { width: 32px; height: 32px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .reinigung-info-btn:hover { background: var(--teal); border-color: var(--teal); }
        .reinigung-info-btn svg { width: 18px; height: 18px; fill: var(--text-secondary); }
        .reinigung-info-btn:hover svg { fill: white; }
        .reinigung-task-body { padding: 16px; }
        .reinigung-umfang { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 16px; padding: 12px; background: var(--bg-input); border-radius: 8px; }
        .reinigung-completion { display: flex; gap: 12px; align-items: flex-start; flex-wrap: wrap; }
        .reinigung-checkbox { width: 32px; height: 32px; border-radius: 8px; border: 2px solid var(--border); background: var(--bg-input); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: var(--transition); }
        .reinigung-checkbox:hover { border-color: var(--teal); }
        .reinigung-checkbox.checked { background: var(--success); border-color: var(--success); }
        .reinigung-checkbox svg { width: 18px; height: 18px; fill: white; opacity: 0; }
        .reinigung-checkbox.checked svg { opacity: 1; }
        .reinigung-name-input { flex: 1; min-width: 150px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-family: inherit; font-size: 14px; color: var(--text-primary); }
        .reinigung-name-input::placeholder { color: var(--text-muted); }
        .reinigung-name-input:focus { outline: none; border-color: var(--teal); }
        .reinigung-timestamp { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; background: var(--bg-secondary); padding: 6px 10px; border-radius: 6px; white-space: nowrap; }
        .reinigung-timestamp.active { background: rgba(46, 204, 113, 0.2); color: var(--success); }
        .reinigung-no-sign { font-size: 12px; color: var(--text-muted); font-style: italic; padding: 8px 0; }
        .reinigung-sign-btn { width: 100%; margin-top: 12px; padding: 12px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: inherit; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); }
        .reinigung-sign-btn:hover { background: var(--teal); border-color: var(--teal); }
        .reinigung-sign-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .reinigung-sign-btn.completed { background: rgba(46, 204, 113, 0.2); border-color: var(--success); color: var(--success); pointer-events: none; }
        .reinigung-done-info { margin-top: 12px; padding: 12px; background: rgba(46, 204, 113, 0.1); border: 1px solid var(--success); border-radius: 8px; }
        .reinigung-done-row { display: flex; justify-content: space-between; align-items: center; font-size: 13px; margin-bottom: 6px; }
        .reinigung-done-row:last-child { margin-bottom: 0; }
        .reinigung-done-label { color: var(--text-muted); }
        .reinigung-done-value { color: var(--success); font-weight: 600; }
        .reinigung-done-sig { margin-top: 8px; background: var(--bg-input); border-radius: 6px; padding: 4px; }
        .reinigung-done-sig img { width: 100%; height: 50px; object-fit: contain; border-radius: 4px; }
        .sign-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .sign-modal.active { display: flex; }
        .sign-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); max-width: 450px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .sign-modal-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .sign-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
        .sign-modal-subtitle { font-size: 14px; color: var(--text-muted); }
        .sign-modal-body { padding: 20px; }
        .sign-modal-task { background: var(--bg-input); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        .sign-modal-field { margin-bottom: 16px; }
        .sign-modal-label { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: block; }
        .sign-modal-input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: inherit; font-size: 15px; color: var(--text-primary); }
        .sign-modal-input:focus { outline: none; border-color: var(--teal); }
        .sign-modal-canvas-wrap { background: var(--bg-input); border: 2px dashed var(--border); border-radius: 8px; position: relative; overflow: hidden; }
        .sign-modal-canvas-wrap.has-signature { border-style: solid; border-color: var(--teal); }
        .sign-modal-canvas { width: 100%; height: 120px; display: block; touch-action: none; cursor: crosshair; }
        .sign-modal-canvas-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); font-size: 14px; pointer-events: none; }
        .sign-modal-canvas-wrap.has-signature .sign-modal-canvas-placeholder { display: none; }
        .sign-modal-canvas-clear { position: absolute; top: 8px; right: 8px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; font-size: 12px; color: var(--text-muted); cursor: pointer; }
        .sign-modal-footer { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 12px; }
        .sign-modal-btn { flex: 1; padding: 14px; border-radius: 10px; font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; border: none; transition: var(--transition); }
        .sign-modal-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .sign-modal-btn.cancel { background: var(--bg-input); color: var(--text-secondary); }
        .sign-modal-btn.confirm { background: var(--teal); color: white; }
        .sign-modal-btn.confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .info-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .info-modal.active { display: flex; }
        .info-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); max-width: 400px; width: 100%; padding: 24px; }
        .info-modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .info-modal-title svg { width: 24px; height: 24px; fill: var(--teal); }
        .info-modal-text { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px; }
        .info-modal-close { width: 100%; padding: 12px; background: var(--teal); border: none; border-radius: 8px; color: white; font-family: inherit; font-size: 15px; font-weight: 600; cursor: pointer; }

        /* SIGNATURE */
        .signature-section { margin: 32px 20px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .signature-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; }
        .signature-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .signature-title svg { width: 24px; height: 24px; fill: var(--accent); }
        .signature-canvas-container { position: relative; background: var(--bg-input); border: 2px dashed var(--border); border-radius: var(--radius); overflow: hidden; touch-action: none; }
        .signature-canvas { width: 100%; height: 200px; display: block; touch-action: none; cursor: crosshair; -webkit-user-select: none; user-select: none; }
        .signature-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--text-muted); font-size: 15px; pointer-events: none; transition: opacity 0.2s; }
        .signature-canvas-container.has-signature .signature-placeholder { opacity: 0; }
        .signature-name { text-align: center; font-size: 14px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--text-secondary); padding: 12px 0; border-top: 1px solid var(--border); margin-top: 8px; min-height: 20px; }
        .signature-actions { display: flex; gap: 12px; margin-top: 16px; }

        /* BUTTONS */
        .btn { width: 100%; padding: 18px 24px; border: none; border-radius: var(--radius); font-family: inherit; font-size: 17px; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent) 0%, #a01830 100%); color: white; box-shadow: 0 4px 16px var(--accent-glow); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 24px var(--accent-glow); }
        .btn-primary:active { transform: translateY(0); }
        .btn-secondary { background: var(--bg-input); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #27ae60 100%); color: white; }
        .btn-share { background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%); color: white; box-shadow: 0 4px 16px rgba(0, 120, 212, 0.3); }
        .btn-share:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(0, 120, 212, 0.4); }
        .btn svg { width: 20px; height: 20px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        .submit-section { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(13, 13, 13, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid var(--border); padding: 16px 20px; padding-bottom: max(16px, env(safe-area-inset-bottom)); }
        .submit-section .btn-primary { max-width: 800px; margin: 0 auto; }

        /* AUDIT-LOG */
        .audit-container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .audit-entry { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; margin-bottom: 12px; }
        .audit-entry-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .audit-entry-action { font-weight: 700; font-size: 14px; color: var(--text-primary); }
        .audit-entry-time { font-size: 12px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
        .audit-entry-user { font-size: 13px; color: var(--accent); margin-bottom: 4px; }
        .audit-entry-details { font-size: 13px; color: var(--text-secondary); }
        .audit-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .audit-entry.delete { border-left: 3px solid #e74c3c; }
        .audit-entry.login { border-left: 3px solid #27ae60; }
        .audit-entry.logout { border-left: 3px solid #f39c12; }
        .audit-entry.create { border-left: 3px solid #3498db; }
        .audit-entry.export { border-left: 3px solid #9b59b6; }

        /* BENUTZERVERWALTUNG */
        .benutzer-container { padding: 20px; max-width: 600px; margin: 0 auto; }
        .benutzer-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 20px; }
        .benutzer-section-title { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: var(--text-primary); }
        .benutzer-list { display: flex; flex-direction: column; gap: 8px; }
        .benutzer-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: var(--bg-input); border-radius: 8px; }
        .benutzer-item-info { flex: 1; }
        .benutzer-item-kuerzel { font-size: 14px; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
        .benutzer-item-name { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .benutzer-item-delete { width: 36px; height: 36px; background: rgba(231, 76, 60, 0.2); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); }
        .benutzer-item-delete:hover { background: #e74c3c; }
        .benutzer-item-delete svg { width: 18px; height: 18px; fill: #e74c3c; }
        .benutzer-item-delete:hover svg { fill: white; }
        .benutzer-empty { text-align: center; padding: 30px; color: var(--text-muted); font-size: 14px; }
        .benutzer-form { display: flex; flex-direction: column; gap: 16px; }
        .benutzer-field { display: flex; flex-direction: column; gap: 6px; }
        .benutzer-label { font-size: 13px; font-weight: 600; color: var(--text-muted); }
        .benutzer-input { padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 15px; color: var(--text-primary); }
        .benutzer-input:focus { outline: none; border-color: var(--accent); }

        /* ARCHIVE */
        .archive-container { padding: 20px; max-width: 800px; margin: 0 auto; }
        .archive-loading, .archive-empty { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .archive-empty-icon { width: 64px; height: 64px; background: var(--bg-card); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .archive-empty-icon svg { width: 32px; height: 32px; fill: var(--text-muted); }
        .archive-item { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; cursor: pointer; transition: var(--transition); }
        .archive-item:hover { border-color: var(--accent); transform: translateY(-2px); }
        .archive-item-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .archive-item-date { font-family: 'JetBrains Mono', monospace; font-size: 16px; font-weight: 600; }
        .archive-item-badge { background: var(--success); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px; }
        .archive-item-details { display: flex; gap: 20px; font-size: 14px; color: var(--text-secondary); }
        .archive-item-detail { display: flex; align-items: center; gap: 6px; }
        .archive-item-detail svg { width: 16px; height: 16px; fill: var(--text-muted); }

        /* MODAL */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { width: 100%; max-width: 500px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 32px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
        .modal-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; }
        .modal-actions { display: flex; gap: 12px; margin-top: 24px; }
        .modal-actions .btn { flex: 1; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
        .input-field { width: 100%; padding: 16px 18px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text-primary); font-family: inherit; font-size: 17px; transition: var(--transition); }
        .input-field:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
        .detail-section { margin-bottom: 20px; }
        .detail-section-title { font-size: 14px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .detail-item { display: flex; align-items: flex-start; justify-content: space-between; padding: 10px 0; font-size: 14px; gap: 12px; }
        .detail-item-label { color: var(--text-secondary); flex: 1; line-height: 1.4; }
        .detail-item-label small { display: block; margin-top: 4px; }
        .detail-item-value { font-weight: 500; flex-shrink: 0; }
        .detail-item-value.success { color: var(--success); }
        .detail-signature { background: var(--bg-input); border-radius: var(--radius); padding: 12px; text-align: center; }
        .detail-signature img { max-width: 100%; height: auto; border-radius: 8px; }

        /* SUCCESS */
        .success-screen { flex-direction: column; align-items: center; justify-content: center; padding: 40px 24px; text-align: center; background: radial-gradient(ellipse at 50% 30%, rgba(46, 204, 113, 0.15) 0%, transparent 50%), var(--bg-primary); }
        .success-screen.active { display: flex; }
        .success-icon { width: 100px; height: 100px; background: var(--success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 32px; box-shadow: 0 0 60px var(--success-glow); animation: successPulse 2s ease infinite; }
        @keyframes successPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        .success-icon svg { width: 50px; height: 50px; fill: white; }
        .success-title { font-size: 28px; font-weight: 700; margin-bottom: 12px; }
        .success-message { font-size: 16px; color: var(--text-secondary); max-width: 400px; line-height: 1.6; margin-bottom: 40px; }
        .success-details { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 32px; text-align: left; width: 100%; max-width: 400px; }
        .success-detail { display: flex; justify-content: space-between; padding: 8px 0; font-size: 14px; }
        .success-detail:not(:last-child) { border-bottom: 1px solid var(--border); }
        .success-detail-label { color: var(--text-secondary); }
        .success-detail-value { font-weight: 600; font-family: 'JetBrains Mono', monospace; }
        .success-actions { display: flex; gap: 12px; width: 100%; max-width: 400px; }
        .success-actions .btn { flex: 1; }

        @media (max-width: 600px) { .tiles-grid { grid-template-columns: 1fr; } .tile { padding: 20px; } .toggle-switch { width: 64px; height: 40px; } .toggle-slider:before { height: 32px; width: 32px; } .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); } }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div class="screen login-screen active" id="loginScreen">
        <div class="login-logo"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg></div>
        <h1 class="login-title">MBWD App</h1>
        <p class="login-subtitle">Mercedes-Benz Werk Dienst</p>
        <div class="login-card">
            <div class="login-field">
                <label class="login-field-label">Kürzel</label>
                <input type="text" class="login-input" id="loginKuerzel" placeholder="z.B. EMSIEBE" autocomplete="off" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()">
            </div>
            <div class="pin-label">PIN eingeben</div>
            <div class="pin-display"><div class="pin-dot" id="dot0"></div><div class="pin-dot" id="dot1"></div><div class="pin-dot" id="dot2"></div><div class="pin-dot" id="dot3"></div></div>
            <div class="pin-pad">
                <button type="button" class="pin-key" onclick="enterPin('1')">1</button>
                <button type="button" class="pin-key" onclick="enterPin('2')">2</button>
                <button type="button" class="pin-key" onclick="enterPin('3')">3</button>
                <button type="button" class="pin-key" onclick="enterPin('4')">4</button>
                <button type="button" class="pin-key" onclick="enterPin('5')">5</button>
                <button type="button" class="pin-key" onclick="enterPin('6')">6</button>
                <button type="button" class="pin-key" onclick="enterPin('7')">7</button>
                <button type="button" class="pin-key" onclick="enterPin('8')">8</button>
                <button type="button" class="pin-key" onclick="enterPin('9')">9</button>
                <button type="button" class="pin-key empty"></button>
                <button type="button" class="pin-key" onclick="enterPin('0')">0</button>
                <button type="button" class="pin-key" onclick="deletePin()"><svg viewBox="0 0 24 24"><path d="M22 3H7c-.69 0-1.23.35-1.59.88L0 12l5.41 8.11c.36.53.9.89 1.59.89h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-3 12.59L17.59 17 14 13.41 10.41 17 9 15.59 12.59 12 9 8.41 10.41 7 14 10.59 17.59 7 19 8.41 15.41 12 19 15.59z"/></svg></button>
            </div>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="screen dashboard-screen" id="dashboardScreen">
        <header class="dashboard-header">
            <div class="dashboard-header-top">
                <div class="dashboard-logo">
                    <div class="dashboard-logo-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg></div>
                    <span class="dashboard-logo-text">MBWD App</span>
                </div>
                <div class="dashboard-user">
                    <span class="user-badge" id="userBadge">User</span>
                    <button class="logout-btn" onclick="logout()" title="Abmelden"><svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg></button>
                </div>
            </div>
            <div class="dashboard-date" id="dashboardDate"></div>
        </header>
        <div class="tiles-container">
            <div class="tiles-section-title">Tägliche Aufgaben</div>
            <div class="tiles-grid">
                <div class="tile red" onclick="openApp('ambulanzcheck')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg></div>
                    <div class="tile-title">Ambulanzcheck</div>
                    <div class="tile-desc">Tägliche Checkliste Gesundheitszentrum</div>
                </div>
                <div class="tile blue" onclick="openApp('mpgcheck')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M18 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM19.5 9.5L21 12h-3.5v3h-1v-3H10V9.5h9.5zM6 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM20 8l3 4v5h-2c0 1.66-1.34 3-3 3s-3-1.34-3-3H9c0 1.66-1.34 3-3 3s-3-1.34-3-3H1V6c0-1.11.89-2 2-2h14v4h3zM3 6v9h.76c.55-.61 1.35-1 2.24-1s1.69.39 2.24 1H10V6H3z"/></svg></div>
                    <div class="tile-title">MPG-Check RTW</div>
                    <div class="tile-desc">Täglicher Medizinprodukte-Check</div>
                </div>
            </div>
            <div class="tiles-section-title">Wöchentliche Aufgaben</div>
            <div class="tiles-grid">
                <div class="tile orange" onclick="openApp('wochencheck')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm-8 4H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg></div>
                    <div class="tile-title">RTW Wochencheck</div>
                    <div class="tile-desc">Wöchentliche Fahrzeugprüfung</div>
                </div>
                <div class="tile teal" onclick="openApp('reinigungsplan')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M19.36 2.72L20.78 4.14l-1.08 1.08c.63.96.91 2.12.64 3.34-.38 1.72-1.8 3.04-3.55 3.31-1.13.18-2.18-.12-3.02-.72L8 16.91V19H6v-2.5l1.5-1.5 1.91-1.91-.85-.85L2 18.8V21h3v-1.69l1.42-1.42L12.5 13c-.6-.84-.9-1.89-.72-3.02.27-1.75 1.59-3.17 3.31-3.55 1.22-.27 2.38.01 3.34.64l1.08-1.08zM17.17 8.83l-2.34-2.34c-.39-.39-.39-1.02 0-1.41l1.41-1.41c.39-.39 1.02-.39 1.41 0l2.34 2.34c.39.39.39 1.02 0 1.41l-1.41 1.41c-.39.39-1.02.39-1.41 0z"/></svg></div>
                    <div class="tile-title">Reinigungsplan</div>
                    <div class="tile-desc">Woechentlicher Reinigungsplan GZ</div>
                </div>
                <div class="tile green disabled">
                    <span class="tile-badge coming">Bald</span>
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <div class="tile-title">Inventar</div>
                    <div class="tile-desc">Materialverwaltung & Bestellungen</div>
                </div>
            </div>
            <div class="tiles-section-title" id="adminSection" style="display:none;">Administration</div>
            <div class="tiles-grid" id="adminTiles" style="display:none;">
                <div class="tile purple" onclick="openApp('archiv')">
                    <span class="tile-badge export" id="exportBadge" style="display:none;background:#e74c3c;">0</span>
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM12 17.5L6.5 12H10v-2h4v2h3.5L12 17.5zM5.12 5l.81-1h12l.94 1H5.12z"/></svg></div>
                    <div class="tile-title">Archiv</div>
                    <div class="tile-desc">Alle gespeicherten Checks einsehen</div>
                </div>
                <div class="tile purple" onclick="openApp('benutzer')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                    <div class="tile-title">Benutzer</div>
                    <div class="tile-desc">Zugänge verwalten</div>
                </div>
                <div class="tile purple" onclick="openApp('auditlog')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg></div>
                    <div class="tile-title">Audit-Log</div>
                    <div class="tile-desc">Änderungsprotokoll einsehen</div>
                </div>
                <div class="tile purple" onclick="openApp('deletelog')">
                    <div class="tile-icon"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div>
                    <div class="tile-title">Lösch-Protokoll</div>
                    <div class="tile-desc">Gelöschte Dokumente einsehen</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AMBULANZCHECK -->
    <div class="screen app-screen" id="ambulanzcheckScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Ambulanzcheck</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportPDF('ambulanz')" title="Als PDF exportieren"><svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg></button>
                </div>
            </div>
            <div class="header-meta">
                <div class="employee-input">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <input type="text" id="employeeName" placeholder="Name eingeben..." class="employee-name-input">
                </div>
                <span class="header-date" id="checkDate"></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width: 0%"></div></div>
            <div class="progress-text"><span id="progressCount">0</span> / <span id="totalCount">0</span> erledigt</div>
        </header>
        <div class="checklist-container" id="checklistContainer"></div>
        <div class="signature-section"><div class="signature-card"><h3 class="signature-title"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Unterschrift</h3><div class="signature-canvas-container" id="signatureContainer"><canvas class="signature-canvas" id="signatureCanvas"></canvas><span class="signature-placeholder">Hier unterschreiben</span></div><div class="signature-name" id="signatureName"></div><div class="signature-actions"><button class="btn btn-secondary" id="clearSignature"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>Löschen</button></div></div></div>
        <div class="submit-section"><button class="btn btn-primary" id="submitBtn" disabled onclick="submitCheck('ambulanz')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Check abschließen & speichern</button></div>
    </div>

    <!-- MPG-CHECK RTW -->
    <div class="screen app-screen" id="mpgcheckScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">MPG-Check RTW</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportPDF('mpg')" title="Als PDF exportieren"><svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg></button>
                </div>
            </div>
            <div class="header-meta">
                <div class="employee-input">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <input type="text" id="mpgEmployeeName" placeholder="Name eingeben..." class="employee-name-input">
                </div>
                <span class="header-date" id="mpgCheckDate"></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="mpgProgressFill" style="width: 0%"></div></div>
            <div class="progress-text"><span id="mpgProgressCount">0</span> / <span id="mpgTotalCount">0</span> erledigt</div>
        </header>
        <div class="checklist-container" id="mpgChecklistContainer"></div>
        <div class="signature-section"><div class="signature-card"><h3 class="signature-title"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Unterschrift</h3><div class="signature-canvas-container" id="mpgSignatureContainer"><canvas class="signature-canvas" id="mpgSignatureCanvas"></canvas><span class="signature-placeholder">Hier unterschreiben</span></div><div class="signature-name" id="mpgSignatureName"></div><div class="signature-actions"><button class="btn btn-secondary" id="mpgClearSignature"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>Löschen</button></div></div></div>
        <div class="submit-section"><button class="btn btn-primary" id="mpgSubmitBtn" disabled onclick="submitCheck('mpg')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Check abschließen & speichern</button></div>
    </div>

    <!-- WOCHENCHECK RTW -->
    <div class="screen app-screen" id="wochencheckScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">RTW Wochencheck</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportPDF('wochen')" title="Als PDF exportieren"><svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg></button>
                </div>
            </div>
            <div class="header-meta">
                <div class="employee-input">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <input type="text" id="wochenEmployeeName" placeholder="Name eingeben..." class="employee-name-input">
                </div>
                <span class="header-date" id="wochenCheckDate"></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="wochenProgressFill" style="width: 0%"></div></div>
            <div class="progress-text"><span id="wochenProgressCount">0</span> / <span id="wochenTotalCount">0</span> erledigt</div>
        </header>
        
        <!-- VERFALL-TRACKER -->
        <div class="expiry-tracker">
            <div class="expiry-card">
                <div class="expiry-header">
                    <h3 class="expiry-title">
                        <svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                        Verfall-Tracker
                    </h3>
                    <span class="expiry-badge" id="expiryCount">0</span>
                </div>
                <div class="expiry-list" id="expiryList">
                    <div class="expiry-empty">Keine Verfallsdaten eingetragen</div>
                </div>
                <div class="expiry-form">
                    <input type="text" class="expiry-input" id="expiryItemName" placeholder="Artikel (z.B. Adrenalin, Infusion...)">
                    <input type="date" class="expiry-input" id="expiryItemDate">
                    <button class="expiry-add-btn" onclick="addExpiryItem()">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Hinzufügen
                    </button>
                </div>
            </div>
        </div>
        
        <div class="checklist-container" id="wochenChecklistContainer"></div>
        <div class="signature-section"><div class="signature-card"><h3 class="signature-title"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Unterschrift</h3><div class="signature-canvas-container" id="wochenSignatureContainer"><canvas class="signature-canvas" id="wochenSignatureCanvas"></canvas><span class="signature-placeholder">Hier unterschreiben</span></div><div class="signature-name" id="wochenSignatureName"></div><div class="signature-actions"><button class="btn btn-secondary" id="wochenClearSignature"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>Löschen</button></div></div></div>
        <div class="submit-section"><button class="btn btn-primary" id="wochenSubmitBtn" disabled onclick="submitCheck('wochen')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Check abschließen & speichern</button></div>
    </div>

    <!-- REINIGUNGSPLAN -->
    <div class="screen app-screen" id="reinigungsplanScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Reinigungsplan</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportPDF('reinigung')" title="Als PDF exportieren"><svg viewBox="0 0 24 24"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg></button>
                </div>
            </div>
            <div class="header-meta">
                <span class="header-date" id="reinigungKW"></span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="reinigungProgressFill" style="width: 0%"></div></div>
            <div class="progress-text"><span id="reinigungProgressCount">0</span> / <span id="reinigungTotalCount">0</span> erledigt</div>
        </header>
        <div class="reinigung-container" id="reinigungContainer"></div>
        <div class="submit-section"><button class="btn btn-primary" id="reinigungSubmitBtn" disabled onclick="submitCheck('reinigung')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Woche abschließen & speichern</button></div>
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <div class="info-modal-title"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>Reinigungsmittel</div>
            <div class="info-modal-text" id="infoModalText"></div>
            <button class="info-modal-close" onclick="closeInfoModal()">Verstanden</button>
        </div>
    </div>

    <!-- Signatur Modal für Reinigungsplan -->
    <div class="sign-modal" id="signModal">
        <div class="sign-modal-content">
            <div class="sign-modal-header">
                <div class="sign-modal-title" id="signModalTitle">Aufgabe bestätigen</div>
                <div class="sign-modal-subtitle" id="signModalSubtitle">Schicht: SI</div>
            </div>
            <div class="sign-modal-body">
                <div class="sign-modal-task" id="signModalTask">Aufgabenbeschreibung...</div>
                <div class="sign-modal-field">
                    <label class="sign-modal-label">Name</label>
                    <input type="text" class="sign-modal-input" id="signModalName" placeholder="Vollständiger Name..." oninput="validateSignModal()">
                </div>
                <div class="sign-modal-field">
                    <label class="sign-modal-label">Unterschrift</label>
                    <div class="sign-modal-canvas-wrap" id="signModalCanvasWrap">
                        <canvas class="sign-modal-canvas" id="signModalCanvas"></canvas>
                        <span class="sign-modal-canvas-placeholder">Hier unterschreiben</span>
                        <button class="sign-modal-canvas-clear" onclick="clearSignModal()">Löschen</button>
                    </div>
                </div>
            </div>
            <div class="sign-modal-footer">
                <button class="sign-modal-btn cancel" onclick="closeSignModal()">Abbrechen</button>
                <button class="sign-modal-btn confirm" id="signModalConfirm" onclick="confirmSignModal()" disabled>
                    <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                    Bestätigen
                </button>
            </div>
        </div>
    </div>

    <!-- ARCHIV -->
    <div class="screen app-screen" id="archivScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Archiv</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="shareWeeklyExport()" title="Wochenexport teilen" style="background:linear-gradient(135deg, #0078d4 0%, #005a9e 100%);">
                        <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    </button>
                </div>
            </div>
        </header>
        <div class="archive-container" id="archiveContainer"><div class="archive-loading">Lade...</div></div>
    </div>

    <!-- BENUTZERVERWALTUNG -->
    <div class="screen app-screen" id="benutzerScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Benutzerverwaltung</h1>
            </div>
        </header>
        <div class="benutzer-container">
            <div class="benutzer-section">
                <h3 class="benutzer-section-title">Registrierte Benutzer</h3>
                <div class="benutzer-list" id="benutzerList">
                    <!-- Wird dynamisch gefüllt -->
                </div>
            </div>
            <div class="benutzer-section">
                <h3 class="benutzer-section-title">Neuen Benutzer anlegen</h3>
                <div class="benutzer-form">
                    <div class="benutzer-field">
                        <label class="benutzer-label">Kürzel (Mercedes-ID)</label>
                        <input type="text" class="benutzer-input" id="newUserKuerzel" placeholder="z.B. EMSIEBE" autocapitalize="characters" oninput="this.value = this.value.toUpperCase()">
                    </div>
                    <div class="benutzer-field">
                        <label class="benutzer-label">Vollständiger Name</label>
                        <input type="text" class="benutzer-input" id="newUserName" placeholder="z.B. Sieber, Erik">
                    </div>
                    <div class="benutzer-field">
                        <label class="benutzer-label">PIN (4-stellig)</label>
                        <input type="password" class="benutzer-input" id="newUserPin" placeholder="****" maxlength="4" pattern="[0-9]*" inputmode="numeric">
                    </div>
                    <button class="btn btn-primary" onclick="addUser()">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                        Benutzer anlegen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AUDIT-LOG -->
    <div class="screen app-screen" id="auditlogScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Audit-Log</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportAuditLog()" title="Exportieren"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
                </div>
            </div>
        </header>
        <div class="audit-container" id="auditContainer">
            <div class="audit-loading">Lade...</div>
        </div>
    </div>

    <!-- LÖSCH-PROTOKOLL -->
    <div class="screen app-screen" id="deletelogScreen">
        <header class="app-header">
            <div class="header-top">
                <button class="back-btn" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                <h1 class="header-title">Lösch-Protokoll</h1>
                <div class="header-actions">
                    <button class="header-btn" onclick="exportDeleteLog()" title="Exportieren"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
                </div>
            </div>
        </header>
        <div class="audit-container" id="deletelogContainer">
            <div class="audit-loading">Lade...</div>
        </div>
    </div>

    <!-- SUCCESS -->
    <div class="screen success-screen" id="successScreen">
        <div class="success-icon"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>
        <h1 class="success-title">Gespeichert!</h1>
        <p class="success-message">Der Ambulanzcheck wurde erfolgreich abgeschlossen.</p>
        <div class="success-details"><div class="success-detail"><span class="success-detail-label">Dokument-ID</span><span class="success-detail-value" id="successDocId" style="font-family:'JetBrains Mono',monospace;color:var(--accent);"></span></div><div class="success-detail"><span class="success-detail-label">Datum</span><span class="success-detail-value" id="successDate"></span></div><div class="success-detail"><span class="success-detail-label">Mitarbeiter</span><span class="success-detail-value" id="successEmployee"></span></div><div class="success-detail"><span class="success-detail-label">Punkte</span><span class="success-detail-value" id="successItems"></span></div></div>
        <div class="success-actions">
            <button class="btn btn-share" onclick="shareProtocol()"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>In Teams/OneDrive ablegen</button>
            <button class="btn btn-secondary" onclick="openApp('archiv')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27z"/></svg>Archiv</button>
            <button class="btn btn-primary" onclick="showScreen('dashboard')"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Dashboard</button>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal-overlay" id="detailModal"><div class="modal" style="max-width:600px;"><h2 class="modal-title" id="detailTitle">Details</h2><p class="modal-subtitle" id="detailSubtitle"></p><div id="detailContent"></div><div class="modal-actions"><button class="btn btn-secondary" onclick="document.getElementById('detailModal').classList.remove('active')">Schließen</button><button class="btn btn-share" id="shareCheckBtn" onclick="shareArchivedCheck()" style="display:none;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>Teilen</button><button class="btn btn-primary" id="deleteCheckBtn" onclick="deleteCheck()" style="background:#e74c3c;display:none;"><svg viewBox="0 0 24 24" fill="currentColor" style="width:18px;height:18px;"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Löschen</button></div></div></div>

    <script>
        // USERS - Admin ist fest, andere aus localStorage
        const ADMIN_PIN = '5400';
        const SESSION_TIMEOUT_MIN = 15; // Automatischer Logout nach 15 Minuten
        const SHAREPOINT_ARCHIV_URL = 'https://mercedesbenz.sharepoint.com/:f:/r/sites/msteams_dbfa96/Freigegebene%20Dokumente/Archiv';
        let sessionTimer = null;
        let lastActivity = Date.now();
        
        function getUsers() {
            try {
                return JSON.parse(localStorage.getItem('mbwd_users') || '{}');
            } catch (e) {
                return {};
            }
        }
        function saveUsers(users) {
            localStorage.setItem('mbwd_users', JSON.stringify(users));
        }
        
        // ============ AUDIT LOG ============
        function getAuditLog() {
            try {
                return JSON.parse(localStorage.getItem('mbwd_audit_log') || '[]');
            } catch (e) {
                return [];
            }
        }
        
        function addAuditEntry(action, details) {
            const log = getAuditLog();
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.kuerzel : 'SYSTEM',
                userName: currentUser ? currentUser.name : 'System',
                action: action,
                details: details
            };
            log.unshift(entry);
            // Maximal 1000 Einträge behalten
            if (log.length > 1000) log.length = 1000;
            localStorage.setItem('mbwd_audit_log', JSON.stringify(log));
        }
        
        // ============ FORTLAUFENDE DOKUMENTEN-ID ============
        function getNextDocId(type) {
            const year = new Date().getFullYear();
            const counterKey = `mbwd_doc_counter_${type}_${year}`;
            let counter = parseInt(localStorage.getItem(counterKey) || '0') + 1;
            localStorage.setItem(counterKey, counter.toString());
            
            const typePrefix = {
                'ambulanz': 'AMB',
                'mpg': 'MPG', 
                'wochen': 'RTW',
                'reinigung': 'RGP'
            };
            
            return `054-${typePrefix[type] || 'DOC'}-${year}-${counter.toString().padStart(5, '0')}`;
        }
        
        // ============ LÖSCH-PROTOKOLL ============
        function getDeleteLog() {
            try {
                return JSON.parse(localStorage.getItem('mbwd_delete_log') || '[]');
            } catch (e) {
                return [];
            }
        }
        
        function addDeleteEntry(docId, docType, docMeta) {
            const log = getDeleteLog();
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                deletedBy: currentUser ? currentUser.kuerzel : 'UNKNOWN',
                deletedByName: currentUser ? currentUser.name : 'Unbekannt',
                documentId: docId,
                documentType: docType,
                documentMeta: docMeta
            };
            log.unshift(entry);
            localStorage.setItem('mbwd_delete_log', JSON.stringify(log));
            addAuditEntry('DOKUMENT_GELÖSCHT', `Dokument ${docId} (${docType}) gelöscht`);
        }
        
        // ============ EXPORT-TRACKING ============
        function getUnexportedCount() {
            const keys = ['ambulanzcheck_archive', 'mpgcheck_archive', 'wochencheck_archive', 'reinigung_archive'];
            let count = 0;
            keys.forEach(key => {
                try {
                    const archive = JSON.parse(localStorage.getItem(key) || '[]');
                    archive.forEach(item => {
                        if (!item.exported) count++;
                    });
                } catch (e) {}
            });
            return count;
        }
        
        function markAsExported(storageKey, docId) {
            try {
                const archive = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const item = archive.find(x => x.id === docId);
                if (item) {
                    item.exported = true;
                    item.exportedAt = new Date().toISOString();
                    item.exportedBy = currentUser ? currentUser.kuerzel : 'UNKNOWN';
                    localStorage.setItem(storageKey, JSON.stringify(archive));
                    addAuditEntry('DOKUMENT_EXPORTIERT', `Dokument ${item.docId || docId} exportiert`);
                }
            } catch (e) {}
        }
        
        function updateExportBadge() {
            const count = getUnexportedCount();
            const badge = document.getElementById('exportBadge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'flex' : 'none';
            }
        }
        
        // ============ MANIPULATIONSSCHUTZ (Hash) ============
        function generateChecksum(data) {
            // Simple hash function for integrity check
            const str = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            // Convert to hex and combine with length for extra security
            return Math.abs(hash).toString(16).toUpperCase().padStart(8, '0') + '-' + str.length.toString(16).toUpperCase();
        }
        
        function verifyChecksum(data, checksum) {
            return generateChecksum(data) === checksum;
        }
        
        // ============ SESSION TIMEOUT ============
        function resetSessionTimer() {
            lastActivity = Date.now();
            if (sessionTimer) clearTimeout(sessionTimer);
            if (currentUser) {
                sessionTimer = setTimeout(sessionTimeout, SESSION_TIMEOUT_MIN * 60 * 1000);
            }
        }
        
        function sessionTimeout() {
            if (currentUser) {
                addAuditEntry('SESSION_TIMEOUT', 'Automatischer Logout wegen Inaktivität');
                alert('Sie wurden wegen Inaktivität automatisch abgemeldet.');
                logout();
            }
        }
        
        function setupActivityListeners() {
            ['click', 'touchstart', 'keypress', 'scroll'].forEach(event => {
                document.addEventListener(event, resetSessionTimer, { passive: true });
            });
        }
        
        let currentUser = null, currentPin = '', checklistState = {}, commentsState = {}, signatureData = null, currentDetailId = null;
        let mpgChecklistState = {}, mpgCommentsState = {}, mpgSignatureData = null;
        let currentCheckType = 'ambulanz';
        let reinigungState = {};
        let lastSavedCheck = null; // Für Share-Funktion
        let currentArchivedCheck = null; // Für Archiv-Share-Funktion

        // AMBULANZ CHECKLIST DATA
        const checklistData=[{id:'corpuls',title:'Corpuls 3',icon:`<svg viewBox="0 0 24 24"><path d="M19.5 6c-1.31 0-2.37 1.01-2.48 2.3-1.88-.5-2.84-.52-4.52.02C12.4 7.01 11.34 6 10.03 6 8.69 6 7.58 7.11 7.58 8.45c0 .65.26 1.24.68 1.68-2.21 1.87-2.62 4.29-2.62 6.37 0 1.1.9 2 2 2h8.72c1.1 0 2-.9 2-2 0-2.08-.41-4.5-2.62-6.37.42-.44.68-1.03.68-1.68C16.42 7.11 15.31 6 13.97 6z"/></svg>`,items:['EKG-Kabel (6- und 12-Kanal) + Rasierer','EKG-Elektroden > 12 Stück','corPatch-Elektroden Erwachsener','CPR-Feedback-Sensor','CO2-Sensor und 1 Küvette','NIBD-Manschette und Schlauch','SpO2-Sensor und Zwischenkabel','Druckerpapier im Druckerfach vorhanden','Testschock mit 200J + Kontrolle Stromabgabe','Ladekonsole (Laden aktiv)','Kommunikation zwischen den Modulen','Batteriestatus der Module','Gerät einschalten (Selbsttest)']},{id:'absaugpumpe',title:'Elektrische Absaugpumpe',icon:`<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>`,items:['Funktion','Pumpe hält Sog bei erreichtem Vakuum','Absaugkatheter (je 2x) + Schlauch & Fingertip','Pumpe lädt in Halterung']},{id:'notfallzimmer',title:'Notfallzimmer',icon:`<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>`,items:['O2-Flaschendruck >50bar (10L)','Rucksack Rot vorhanden','EKG-Rechner eingeschaltet','Rucksack Gelb vorhanden','OP-Leuchte Funktion','Gelb: O2>80bar, Laryngoskop Funktion','Infusionsständer mit 2x Infusion + Besteck','Zentrifuge Funktion / Blut kühlen','Kühl- und Gefrierschrank Funktion','SicSac in Spender >5 Stück']},{id:'ambulanz1',title:'Ambulanz 1',icon:`<svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm6 11h-3v3h-2v-3H8v-2h3v-3h2v3h3v2z"/></svg>`,items:['OP-Leuchte Funktion','Ambulanzwagen sauber, befüllt','Spaltlampe Funktion','Otoskop Funktion','Kryo-Fos Funktion/Akku/Ladung','Augenspülflasche in Spiegelschrank']},{id:'ambulanz2',title:'Ambulanz 2',icon:`<svg viewBox="0 0 24 24"><path d="M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm6 11h-3v3h-2v-3H8v-2h3v-3h2v3h3v2z"/></svg>`,items:['OP-Leuchte Funktion','Ambulanzwagen sauber, befüllt','Desinfektionsbad leer','Otoskop Funktion','Kryo-Fos Funktion/Akku/Ladung']},{id:'ruheraum',title:'Ruheraum',icon:`<svg viewBox="0 0 24 24"><path d="M7 13c1.66 0 3-1.34 3-3S8.66 7 7 7s-3 1.34-3 3 1.34 3 3 3zm12-6h-8v7H3V7H1v10h22v-6c0-2.21-1.79-4-4-4z"/></svg>`,items:['Liegen sauber / Decken vorhanden','SicSac in Spender >5 Stück']},{id:'physio',title:'Physikalische Therapie',icon:`<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`,items:['Liegen sauber / Ärztekrepp vorhanden','Reizstromgerät Funktion/Sauberkeit','Rotlicht vorne Funktion/Sauberkeit','Rotlicht mittig Funktion/Sauberkeit','SicSac in Spender >5 Stück','Elacur + Voltaren vorhanden','Schwämme abkochen']},{id:'aufenthalt',title:'Aufenthaltsraum',icon:`<svg viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>`,items:['Schalter "Patientenklingel" eingeschaltet','Schwesternruf grüne Leuchte an']},{id:'sonntag',title:'Nur Sonntag',icon:`<svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/></svg>`,items:['Notruftelefon Funktion überprüft','Dokumente Leitstelle abholen'],isSunday:true}];

        // MPG-CHECK RTW CHECKLIST DATA
        const mpgChecklistData=[
            {id:'mpg-corpuls',title:'Corpuls³',icon:`<svg viewBox="0 0 24 24"><path d="M19.5 6c-1.31 0-2.37 1.01-2.48 2.3-1.88-.5-2.84-.52-4.52.02C12.4 7.01 11.34 6 10.03 6 8.69 6 7.58 7.11 7.58 8.45c0 .65.26 1.24.68 1.68-2.21 1.87-2.62 4.29-2.62 6.37 0 1.1.9 2 2 2h8.72c1.1 0 2-.9 2-2 0-2.08-.41-4.5-2.62-6.37.42-.44.68-1.03.68-1.68C16.42 7.11 15.31 6 13.97 6z"/></svg>`,items:['EKG-Kabel (6- und 12-Kanal) + 3 Rasierer','EKG-Elektroden > 12 Stück','corPatch-Elektroden Erwachsener + Kinder','CPR-Feedback-Sensor','CO2-Sensor und 1 Küvette','NIBP-Manschette und Schlauch','SpO2-Sensor und Zwischenkabel','Druckerpapier im Druckerfach vorhanden','Testschock 200J + Kontrolle Stromabgabe (via Taste Einsatz)','Ladekonsole (Laden aktiv)','Kommunikation zwischen den Modulen','Batteriestatus der Module','Gerät einschalten (Selbsttest)']},
            {id:'mpg-absaug',title:'Elektrische Absaugpumpe',icon:`<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.93 0 3.5 1.57 3.5 3.5S13.93 13 12 13s-3.5-1.57-3.5-3.5S10.07 6 12 6zm7 13H5v-.23c0-.62.28-1.2.76-1.58C7.47 15.82 9.64 15 12 15s4.53.82 6.24 2.19c.48.38.76.97.76 1.58V19z"/></svg>`,items:['Funktion','Pumpe hält Sog bei erreichtem Vakuum','Absaugkatheter (je 2x) + Schlauch + Fingertip','Pumpe lädt in Halterung']},
            {id:'mpg-oxybag',title:'Oxybag',icon:`<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>`,items:['Flaschendruck > 80bar','2x Sauerstoffmasken','Funktion und Dichtigkeit','1x Gänsegurgel','Beatmungsbeutel mit Versorgungsleitung','1x Hyperventilationsmaske','Funktion und Sauberkeit in Ordnung?','1x Verneblermaske']},
            {id:'mpg-medumat',title:'Medumat Standard',icon:`<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>`,items:['Flaschendruck > 100bar','Außentasche: Prüfbeutel, O²-Maske, Filter','Funktion Inhalation','Sichtprüfung: Patientenventil, Schlauch']},
            {id:'mpg-beatmung',title:'Medumat - Beatmungsfunktionen',icon:`<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`,items:['Einstellung Frequenz 8/min. (+/-1)','Einstellung Druck 20mbar (+/-5)','Einstellung Frequenz 40/min. (+/-2)','Einstellung Druck 60mbar (+/-5)','Vollständiges Aufblähen des Prüfbeutels bei: 8/min. + 8L/min']},
            {id:'mpg-alarme',title:'Medumat - Alarme prüfen',icon:`<svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z"/></svg>`,items:['Atemsystemunterbrechung (Diskonnektion)','Stenosis','Kein Abfall des Sauerstoff-Versorgungsdruck']},
            {id:'mpg-rtw',title:'Außenschrank / RTW',icon:`<svg viewBox="0 0 24 24"><path d="M18 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM19.5 9.5L21 12h-3.5v3h-1v-3H10V9.5h9.5zM6 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM20 8l3 4v5h-2c0 1.66-1.34 3-3 3s-3-1.34-3-3H9c0 1.66-1.34 3-3 3s-3-1.34-3-3H1V6c0-1.11.89-2 2-2h14v4h3zM3 6v9h.76c.55-.61 1.35-1 2.24-1s1.69.39 2.24 1H10V6H3z"/></svg>`,items:['Flaschendruck li. Flasche > 50bar','Flaschendruck re. Flasche > 50bar','Funktion und Dichtigkeit','2L O²-Flasche vorhanden? (Reserveflasche)','Morphin 1ml/mg (Soll 4 Ampullen)','Prüfung Funktion Laryngoskop Fach 7','Fentanyl 0,5mg/10ml (Soll 4 Ampullen)','Desinfektion der Griffe & Arbeitsflächen']}
        ];

        // WÖCHENTLICHER RTW CHECK DATA
        let wochenChecklistState = {}, wochenCommentsState = {}, wochenSignatureData = null;
        const wochenChecklistData=[
            {id:'wochen-rtw',title:'RTW Wochencheck',icon:`<svg viewBox="0 0 24 24"><path d="M18 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM19.5 9.5L21 12h-3.5v3h-1v-3H10V9.5h9.5zM6 18.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM20 8l3 4v5h-2c0 1.66-1.34 3-3 3s-3-1.34-3-3H9c0 1.66-1.34 3-3 3s-3-1.34-3-3H1V6c0-1.11.89-2 2-2h14v4h3zM3 6v9h.76c.55-.61 1.35-1 2.24-1s1.69.39 2.24 1H10V6H3z"/></svg>`,items:[
                {text:'Thermobox Funktion?'},
                {text:'Tragetisch alle Funktionen?'},
                {text:'Innenbeleuchtung, alle Lichter Funktion?'}
            ]},
            {id:'wochen-checklisten',title:'Checklisten prüfen',icon:`<svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>`,items:[
                {text:'Nach Checkliste „Corpuls3_EKG_Defibrillator"', doc:'054_CL_Corpuls3_EKG_Defibrillator.pdf'},
                {text:'Nach Checkliste „AccuvacRescue_Absaugpumpe"', doc:'054_CL_AccuvacRescue_Absaugpumpe.pdf'},
                {text:'Nach Checkliste „Medumat_Standard_Beatmungsgeraet"', doc:'054_CL_Medumat_Standard_Beatmungsgeraet.pdf'},
                {text:'Nach Checkliste „MANV_Tasche_RTW"', doc:'054_CL_MANV_Tasche_RTW.pdf'},
                {text:'Nach Checkliste „Notfallrucksaecke_Rot&Gelb"', doc:'054_CL_Notfallrucksaecke_Rot_Gelb.pdf'},
                {text:'Nach Checkliste „Notfallrucksack_Kinder"', doc:'054_CL_Notfallrucksack_Kinder.pdf'}
            ]},
            {id:'wochen-verfall',title:'Verfall prüfen (letzte KW des Monats)',icon:`<svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>`,items:[
                {text:'Check mit Verfall durchgeführt?'}
            ],isLastWeek:true}
        ];

        // REINIGUNGSPLAN DATA
        const reinigungsPlanData = {
            montag: [
                { schicht: 'SI', bereich: 'Ruheraum', umfang: 'Liege, Schränke, Tabletts', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' },
                { schicht: 'SI', bereich: 'EKG/Notfall', umfang: 'Komplettes Inventar\nEKG Saugelektroden umstülpen und von innen Desinfizieren!', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' }
            ],
            mittwoch: [
                { schicht: 'SI', bereich: 'Physikalische Therapie', umfang: 'Liege, Schränke, Tabletts', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' }
            ],
            donnerstag: [
                { schicht: 'FI', bereich: 'Ambulanz 2', umfang: 'Schreibtisch, Stühle, alle Oberflächen, Behandlungsplatz mit allen Tabletts', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten', hinweis: 'FII wenn anwesend' },
                { schicht: 'DI', bereich: 'Diagnostik 1', umfang: 'Schreibtisch, Liege, Geräte, alle Oberflächen', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' },
                { schicht: 'DII', bereich: 'Diagnostik 2', umfang: 'Schreibtisch, Liege, Geräte, alle Oberflächen', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' }
            ],
            freitag: [
                { schicht: 'SI', bereich: 'Ambulanz 1 + Toilette Diagnostik', umfang: 'Schreibtisch, Stühle, alle Oberflächen, Behandlungsplatz mit allen Tabletts, Ablageschale, Ablage vom Tisch, Schlitten Urisys', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten' },
                { schicht: 'Sek.', bereich: 'Wartezone', umfang: 'Auf Sauberkeit und Ordnung achten.\nBlumen gießen.\nGläser Ablage reinigen und Gläser wechseln', womit: 'Mikrobac Tissues\nEinwirkzeit 1-5 Minuten\nOder Schonreiniger', noSign: true },
                { schicht: 'BGF', bereich: 'Besprechungszimmer', umfang: 'Auf Sauberkeit und Ordnung achten.', womit: '', noSign: true },
                { schicht: 'SI', bereich: 'Ambulanz 2 - Desinfektion', umfang: 'Desinfektionslösung Ansetzen und Gegenstände einlegen.\nNach 60 Min. Einwirkzeit gründlich mit kaltem Wasser abspülen.', womit: '0,5% Lösung lt. Plan\nEinwirkzeit 60 Min.\ngigasept® Instru AF' }
            ]
        };

        // SCREENS
        function showScreen(name) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(name + 'Screen').classList.add('active');
            window.scrollTo(0, 0);
        }

        // PIN
        function enterPin(digit) { 
            if (currentPin.length < 4) { 
                currentPin += digit; 
                updatePinDisplay(); 
                if (currentPin.length === 4) setTimeout(checkPin, 200); 
            } 
        }
        function deletePin() { 
            currentPin = currentPin.slice(0, -1); 
            updatePinDisplay(); 
        }
        function updatePinDisplay() { 
            for (let i = 0; i < 4; i++) { 
                const dot = document.getElementById('dot' + i); 
                dot.classList.toggle('filled', i < currentPin.length); 
                dot.classList.remove('error'); 
            }
            document.getElementById('loginError').classList.remove('show');
        }
        function showLoginError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.classList.add('show');
            document.querySelectorAll('.pin-dot').forEach(d => d.classList.add('error'));
            setTimeout(() => { currentPin = ''; updatePinDisplay(); }, 1500);
        }
        function checkPin() {
            const kuerzel = document.getElementById('loginKuerzel').value.trim().toUpperCase();
            
            // Admin Login (Kürzel: ADMIN, PIN: 5400)
            if (kuerzel === 'ADMIN' && currentPin === ADMIN_PIN) {
                currentUser = { role: 'admin', name: 'Administrator', kuerzel: 'ADMIN' };
                loginSuccess();
                return;
            }
            
            // User Login
            const users = getUsers();
            if (users[kuerzel] && users[kuerzel].pin === currentPin) {
                currentUser = { role: 'user', name: users[kuerzel].name, kuerzel: kuerzel };
                loginSuccess();
                return;
            }
            
            // Fehler
            if (!kuerzel) {
                showLoginError('Bitte Kürzel eingeben');
            } else if (!users[kuerzel] && kuerzel !== 'ADMIN') {
                showLoginError('Kürzel nicht gefunden');
            } else {
                showLoginError('Falsche PIN');
            }
        }
        function loginSuccess() {
            document.getElementById('userBadge').textContent = currentUser.kuerzel;
            document.getElementById('userBadge').classList.toggle('admin', currentUser.role === 'admin');
            document.getElementById('adminSection').style.display = currentUser.role === 'admin' ? 'block' : 'none';
            document.getElementById('adminTiles').style.display = currentUser.role === 'admin' ? 'grid' : 'none';
            document.getElementById('dashboardDate').textContent = new Date().toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
            currentPin = '';
            document.getElementById('loginKuerzel').value = '';
            updatePinDisplay();
            
            // Audit Log & Session
            addAuditEntry('LOGIN', `Benutzer ${currentUser.kuerzel} angemeldet`);
            resetSessionTimer();
            updateExportBadge();
            
            showScreen('dashboard');
        }
        function logout() { 
            if (currentUser) {
                addAuditEntry('LOGOUT', `Benutzer ${currentUser.kuerzel} abgemeldet`);
            }
            if (sessionTimer) clearTimeout(sessionTimer);
            currentUser = null; 
            currentPin = ''; 
            document.getElementById('loginKuerzel').value = '';
            updatePinDisplay();
            showScreen('login'); 
        }

        // BENUTZERVERWALTUNG
        function loadBenutzerList() {
            const users = getUsers();
            const list = document.getElementById('benutzerList');
            const userKeys = Object.keys(users);
            
            if (userKeys.length === 0) {
                list.innerHTML = '<div class="benutzer-empty">Noch keine Benutzer angelegt.<br>Füge den ersten Benutzer hinzu!</div>';
                return;
            }
            
            list.innerHTML = userKeys.map(kuerzel => `
                <div class="benutzer-item">
                    <div class="benutzer-item-info">
                        <div class="benutzer-item-kuerzel">${kuerzel}</div>
                        <div class="benutzer-item-name">${users[kuerzel].name}</div>
                    </div>
                    <button class="benutzer-item-delete" onclick="deleteUser('${kuerzel}')" title="Löschen">
                        <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                    </button>
                </div>
            `).join('');
        }
        
        function addUser() {
            const kuerzel = document.getElementById('newUserKuerzel').value.trim().toUpperCase();
            const name = document.getElementById('newUserName').value.trim();
            const pin = document.getElementById('newUserPin').value.trim();
            
            if (!kuerzel) { alert('Bitte Kürzel eingeben'); return; }
            if (!name) { alert('Bitte Namen eingeben'); return; }
            if (!pin || pin.length !== 4 || !/^\d{4}$/.test(pin)) { alert('Bitte 4-stellige PIN eingeben (nur Zahlen)'); return; }
            if (kuerzel === 'ADMIN') { alert('Kürzel "ADMIN" ist reserviert'); return; }
            
            const users = getUsers();
            if (users[kuerzel]) { 
                if (!confirm(`Benutzer "${kuerzel}" existiert bereits. Überschreiben?`)) return;
            }
            
            users[kuerzel] = { name: name, pin: pin };
            saveUsers(users);
            
            // Felder leeren
            document.getElementById('newUserKuerzel').value = '';
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserPin').value = '';
            
            loadBenutzerList();
            alert(`Benutzer "${kuerzel}" wurde angelegt.`);
        }
        
        function deleteUser(kuerzel) {
            if (!confirm(`Benutzer "${kuerzel}" wirklich löschen?`)) return;
            
            const users = getUsers();
            delete users[kuerzel];
            saveUsers(users);
            loadBenutzerList();
        }

        // APPS
        function openApp(app) {
            if (app === 'ambulanzcheck') { currentCheckType = 'ambulanz'; initAmbulanzcheck(); showScreen('ambulanzcheck'); }
            else if (app === 'mpgcheck') { currentCheckType = 'mpg'; initMpgCheck(); showScreen('mpgcheck'); }
            else if (app === 'wochencheck') { currentCheckType = 'wochen'; initWochenCheck(); showScreen('wochencheck'); }
            else if (app === 'reinigungsplan') { currentCheckType = 'reinigung'; initReinigungsplan(); showScreen('reinigungsplan'); }
            else if (app === 'archiv') { loadArchive(); showScreen('archiv'); }
            else if (app === 'benutzer') { loadBenutzerList(); showScreen('benutzer'); }
            else if (app === 'auditlog') { loadAuditLog(); showScreen('auditlog'); }
            else if (app === 'deletelog') { loadDeleteLog(); showScreen('deletelog'); }
        }
        
        // AUDIT-LOG FUNKTIONEN
        function loadAuditLog() {
            const log = getAuditLog();
            const container = document.getElementById('auditContainer');
            
            if (log.length === 0) {
                container.innerHTML = '<div class="audit-empty">Keine Einträge vorhanden.</div>';
                return;
            }
            
            container.innerHTML = log.slice(0, 200).map(entry => {
                let entryClass = '';
                if (entry.action.includes('LOGIN')) entryClass = 'login';
                else if (entry.action.includes('LOGOUT') || entry.action.includes('TIMEOUT')) entryClass = 'logout';
                else if (entry.action.includes('GELÖSCHT')) entryClass = 'delete';
                else if (entry.action.includes('ERSTELLT') || entry.action.includes('ABGESCHLOSSEN')) entryClass = 'create';
                else if (entry.action.includes('EXPORT')) entryClass = 'export';
                
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                return `
                    <div class="audit-entry ${entryClass}">
                        <div class="audit-entry-header">
                            <span class="audit-entry-action">${entry.action}</span>
                            <span class="audit-entry-time">${dateStr} ${timeStr}</span>
                        </div>
                        <div class="audit-entry-user">👤 ${entry.user} (${entry.userName})</div>
                        <div class="audit-entry-details">${entry.details}</div>
                    </div>
                `;
            }).join('');
        }
        
        function loadDeleteLog() {
            const log = getDeleteLog();
            const container = document.getElementById('deletelogContainer');
            
            if (log.length === 0) {
                container.innerHTML = '<div class="audit-empty">Keine gelöschten Dokumente.</div>';
                return;
            }
            
            container.innerHTML = log.map(entry => {
                const date = new Date(entry.timestamp);
                const dateStr = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="audit-entry delete">
                        <div class="audit-entry-header">
                            <span class="audit-entry-action">🗑️ ${entry.documentId}</span>
                            <span class="audit-entry-time">${dateStr} ${timeStr}</span>
                        </div>
                        <div class="audit-entry-user">Gelöscht von: ${entry.deletedBy} (${entry.deletedByName})</div>
                        <div class="audit-entry-details">
                            Typ: ${entry.documentType}<br>
                            Original-Datum: ${entry.documentMeta?.datum || 'Unbekannt'}<br>
                            Original-Mitarbeiter: ${entry.documentMeta?.mitarbeiter || entry.documentMeta?.user || 'Unbekannt'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function exportAuditLog() {
            const log = getAuditLog();
            let csv = 'Zeitstempel;Benutzer;Name;Aktion;Details\n';
            log.forEach(entry => {
                csv += `${entry.timestamp};${entry.user};${entry.userName};${entry.action};"${entry.details}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Audit_Log_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            addAuditEntry('AUDIT_LOG_EXPORTIERT', 'Audit-Log als CSV exportiert');
        }
        
        function exportDeleteLog() {
            const log = getDeleteLog();
            let csv = 'Zeitstempel;Gelöscht von;Name;Dokument-ID;Typ;Original-Datum;Original-Mitarbeiter\n';
            log.forEach(entry => {
                csv += `${entry.timestamp};${entry.deletedBy};${entry.deletedByName};${entry.documentId};${entry.documentType};${entry.documentMeta?.datum || ''};${entry.documentMeta?.mitarbeiter || entry.documentMeta?.user || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Loesch_Protokoll_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            addAuditEntry('LÖSCH_LOG_EXPORTIERT', 'Lösch-Protokoll als CSV exportiert');
        }

        // AMBULANZCHECK
        function initAmbulanzcheck() {
            document.getElementById('checkDate').textContent = new Date().toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('employeeName').value = currentUser ? currentUser.name : '';
            document.getElementById('signatureName').textContent = currentUser ? currentUser.name.toUpperCase() : '';
            checklistState = {}; commentsState = {}; signatureData = null;
            checklistData.forEach(s => s.items.forEach((_, i) => { checklistState[`${s.id}-${i}`] = false; }));
            renderChecklist(); updateProgress();
            // Delay signature canvas setup until screen is fully visible
            setTimeout(setupSignatureCanvas, 500);
            document.getElementById('employeeName').addEventListener('input', function() {
                validateForm();
                document.getElementById('signatureName').textContent = this.value.toUpperCase();
            });
        }
        function renderChecklist() {
            const c = document.getElementById('checklistContainer'), sun = new Date().getDay() === 0;
            let h = ''; checklistData.forEach(s => {
                if (s.isSunday && !sun) return;
                h += `<div class="${s.isSunday ? 'section sunday-section' : 'section'}" data-section="${s.id}"><div class="section-header" onclick="toggleSection('${s.id}')"><div class="section-icon">${s.icon}</div><div class="section-info"><div class="section-title">${s.title}</div><div class="section-count" id="count-${s.id}">0 / ${s.items.length}</div></div><div class="section-toggle"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg></div></div><div class="section-content">${s.items.map((it, i) => `<div class="check-item"><div class="check-item-row"><span class="check-label" id="label-${s.id}-${i}">${it}</span><button class="comment-toggle" onclick="toggleComment('${s.id}-${i}')" title="Kommentar hinzufügen"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg></button><label class="toggle-switch"><input type="checkbox" data-key="${s.id}-${i}" onchange="handleCheckChange(this)"><span class="toggle-slider"></span></label></div><div class="comment-field" id="comment-field-${s.id}-${i}"><textarea class="comment-input" id="comment-${s.id}-${i}" placeholder="Kommentar eingeben (z.B. O2: 85 bar, Fehlfunktion...)" oninput="updateCommentToggle('${s.id}-${i}')"></textarea></div></div>`).join('')}</div></div>`;
            });
            c.innerHTML = h;
            let tot = 0; checklistData.forEach(s => { if (!s.isSunday || sun) tot += s.items.length; });
            document.getElementById('totalCount').textContent = tot;
        }
        function toggleSection(id) { document.querySelector(`[data-section="${id}"]`).classList.toggle('collapsed'); }
        function toggleComment(key) { 
            const field = document.getElementById(`comment-field-${key}`);
            field.classList.toggle('show');
            if (field.classList.contains('show')) {
                document.getElementById(`comment-${key}`).focus();
            }
        }
        function updateCommentToggle(key) {
            const input = document.getElementById(`comment-${key}`);
            const toggle = input.closest('.check-item').querySelector('.comment-toggle');
            const hasComment = input.value.trim().length > 0;
            toggle.classList.toggle('has-comment', hasComment);
            commentsState[key] = input.value;
        }
        function handleCheckChange(cb) { checklistState[cb.dataset.key] = cb.checked; document.getElementById(`label-${cb.dataset.key}`).classList.toggle('checked', cb.checked); updateProgress(); validateForm(); }
        function updateProgress() {
            const sun = new Date().getDay() === 0; let ck = 0, tot = 0;
            checklistData.forEach(s => { if (s.isSunday && !sun) return; let sc = 0; s.items.forEach((_, i) => { if (checklistState[`${s.id}-${i}`]) { ck++; sc++; } tot++; }); const c = document.getElementById(`count-${s.id}`); if (c) c.textContent = `${sc} / ${s.items.length}`; });
            document.getElementById('progressCount').textContent = ck;
            document.getElementById('progressFill').style.width = `${tot > 0 ? (ck / tot) * 100 : 0}%`;
        }
        function validateForm() {
            const sun = new Date().getDay() === 0; let all = true;
            const employeeName = document.getElementById('employeeName').value.trim();
            checklistData.forEach(s => { if (s.isSunday && !sun) return; s.items.forEach((_, i) => { if (!checklistState[`${s.id}-${i}`]) all = false; }); });
            document.getElementById('submitBtn').disabled = !signatureData || !all || !employeeName;
        }
        function setupSignatureCanvas() {
            var canvas = document.getElementById('signatureCanvas');
            var cont = document.getElementById('signatureContainer');
            var ctx = canvas.getContext('2d');
            var isDrawing = false;
            var canvasReady = false;
            
            // Set canvas size
            function initCanvas() {
                var rect = canvas.getBoundingClientRect();
                var w = rect.width > 0 ? rect.width : 300;
                var h = rect.height > 0 ? rect.height : 200;
                canvas.width = w * 2;
                canvas.height = h * 2;
                // Reset transform completely before scaling
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(2, 2);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.clearRect(0, 0, w, h);
                canvasReady = true;
            }
            initCanvas();
            
            function getXY(e) {
                var rect = canvas.getBoundingClientRect();
                var clientX, clientY;
                if (e.touches && e.touches[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }
            
            function startDraw(e) {
                e.preventDefault();
                if (!canvasReady) initCanvas();
                isDrawing = true;
                var pos = getXY(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
            
            function doDraw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                var pos = getXY(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                cont.classList.add('has-signature');
                signatureData = canvas.toDataURL('image/png');
                validateForm();
            }
            
            function endDraw() {
                isDrawing = false;
            }
            
            // Mouse events
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseleave', endDraw);
            
            // Touch events
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', endDraw);
            
            // Clear button
            document.getElementById('clearSignature').addEventListener('click', function() {
                initCanvas();
                cont.classList.remove('has-signature');
                signatureData = null;
                validateForm();
            });
        }

        // MPG-CHECK FUNCTIONS
        function initMpgCheck() {
            document.getElementById('mpgCheckDate').textContent = new Date().toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit', year: 'numeric' });
            document.getElementById('mpgEmployeeName').value = currentUser ? currentUser.name : '';
            document.getElementById('mpgSignatureName').textContent = currentUser ? currentUser.name.toUpperCase() : '';
            mpgChecklistState = {}; mpgCommentsState = {}; mpgSignatureData = null;
            mpgChecklistData.forEach(s => s.items.forEach((_, i) => { mpgChecklistState[`${s.id}-${i}`] = false; }));
            renderMpgChecklist(); updateMpgProgress();
            setTimeout(setupMpgSignatureCanvas, 500);
            document.getElementById('mpgEmployeeName').addEventListener('input', function() {
                validateMpgForm();
                document.getElementById('mpgSignatureName').textContent = this.value.toUpperCase();
            });
        }
        function renderMpgChecklist() {
            const c = document.getElementById('mpgChecklistContainer');
            let h = ''; mpgChecklistData.forEach(s => {
                h += `<div class="section" data-section="${s.id}"><div class="section-header" onclick="toggleSection('${s.id}')"><div class="section-icon">${s.icon}</div><div class="section-info"><div class="section-title">${s.title}</div><div class="section-count" id="count-${s.id}">0 / ${s.items.length}</div></div><div class="section-toggle"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg></div></div><div class="section-content">${s.items.map((it, i) => `<div class="check-item"><div class="check-item-row"><span class="check-label" id="label-${s.id}-${i}">${it}</span><button class="comment-toggle" onclick="toggleMpgComment('${s.id}-${i}')" title="Kommentar hinzufügen"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg></button><label class="toggle-switch"><input type="checkbox" data-key="${s.id}-${i}" onchange="handleMpgCheckChange(this)"><span class="toggle-slider"></span></label></div><div class="comment-field" id="mpg-comment-field-${s.id}-${i}"><textarea class="comment-input" id="mpg-comment-${s.id}-${i}" placeholder="Kommentar eingeben..." oninput="updateMpgCommentToggle('${s.id}-${i}')"></textarea></div></div>`).join('')}</div></div>`;
            });
            c.innerHTML = h;
            let tot = 0; mpgChecklistData.forEach(s => { tot += s.items.length; });
            document.getElementById('mpgTotalCount').textContent = tot;
        }
        function toggleMpgComment(key) { 
            const field = document.getElementById(`mpg-comment-field-${key}`);
            field.classList.toggle('show');
            if (field.classList.contains('show')) {
                document.getElementById(`mpg-comment-${key}`).focus();
            }
        }
        function updateMpgCommentToggle(key) {
            const input = document.getElementById(`mpg-comment-${key}`);
            const toggle = input.closest('.check-item').querySelector('.comment-toggle');
            const hasComment = input.value.trim().length > 0;
            toggle.classList.toggle('has-comment', hasComment);
            mpgCommentsState[key] = input.value;
        }
        function handleMpgCheckChange(cb) { mpgChecklistState[cb.dataset.key] = cb.checked; document.getElementById(`label-${cb.dataset.key}`).classList.toggle('checked', cb.checked); updateMpgProgress(); validateMpgForm(); }
        function updateMpgProgress() {
            let ck = 0, tot = 0;
            mpgChecklistData.forEach(s => { let sc = 0; s.items.forEach((_, i) => { if (mpgChecklistState[`${s.id}-${i}`]) { ck++; sc++; } tot++; }); const c = document.getElementById(`count-${s.id}`); if (c) c.textContent = `${sc} / ${s.items.length}`; });
            document.getElementById('mpgProgressCount').textContent = ck;
            document.getElementById('mpgProgressFill').style.width = `${tot > 0 ? (ck / tot) * 100 : 0}%`;
        }
        function validateMpgForm() {
            let all = true;
            const employeeName = document.getElementById('mpgEmployeeName').value.trim();
            mpgChecklistData.forEach(s => { s.items.forEach((_, i) => { if (!mpgChecklistState[`${s.id}-${i}`]) all = false; }); });
            document.getElementById('mpgSubmitBtn').disabled = !mpgSignatureData || !all || !employeeName;
        }
        function setupMpgSignatureCanvas() {
            var canvas = document.getElementById('mpgSignatureCanvas');
            var cont = document.getElementById('mpgSignatureContainer');
            var ctx = canvas.getContext('2d');
            var isDrawing = false;
            var canvasReady = false;
            
            function initCanvas() {
                var rect = canvas.getBoundingClientRect();
                var w = rect.width > 0 ? rect.width : 300;
                var h = rect.height > 0 ? rect.height : 200;
                canvas.width = w * 2;
                canvas.height = h * 2;
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(2, 2);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.clearRect(0, 0, w, h);
                canvasReady = true;
            }
            initCanvas();
            
            function getXY(e) {
                var rect = canvas.getBoundingClientRect();
                var clientX, clientY;
                if (e.touches && e.touches[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { x: clientX - rect.left, y: clientY - rect.top };
            }
            
            function startDraw(e) {
                e.preventDefault();
                if (!canvasReady) initCanvas();
                isDrawing = true;
                var pos = getXY(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
            
            function doDraw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                var pos = getXY(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                cont.classList.add('has-signature');
                mpgSignatureData = canvas.toDataURL('image/png');
                validateMpgForm();
            }
            
            function endDraw() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseleave', endDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', endDraw);
            
            document.getElementById('mpgClearSignature').addEventListener('click', function() {
                initCanvas();
                cont.classList.remove('has-signature');
                mpgSignatureData = null;
                validateMpgForm();
            });
        }

        // WOCHENCHECK FUNCTIONS
        function initWochenCheck() {
            var now = new Date();
            var kw = getWeekNumber(now);
            document.getElementById('wochenCheckDate').textContent = 'KW ' + kw + ' / ' + now.toLocaleDateString('de-DE', { year: 'numeric' });
            document.getElementById('wochenEmployeeName').value = currentUser ? currentUser.name : '';
            document.getElementById('wochenSignatureName').textContent = currentUser ? currentUser.name.toUpperCase() : '';
            wochenChecklistState = {}; wochenCommentsState = {}; wochenSignatureData = null;
            wochenChecklistData.forEach(s => s.items.forEach((_, i) => { wochenChecklistState[`${s.id}-${i}`] = false; }));
            renderWochenChecklist(); updateWochenProgress();
            renderExpiryTracker(); // Verfall-Tracker laden
            setTimeout(setupWochenSignatureCanvas, 500);
            document.getElementById('wochenEmployeeName').addEventListener('input', function() {
                validateWochenForm();
                document.getElementById('wochenSignatureName').textContent = this.value.toUpperCase();
            });
        }
        
        // VERFALL-TRACKER FUNCTIONS
        function getExpiryItems() {
            try {
                return JSON.parse(localStorage.getItem('rtw_expiry_tracker') || '[]');
            } catch (e) {
                return [];
            }
        }
        
        function saveExpiryItems(items) {
            localStorage.setItem('rtw_expiry_tracker', JSON.stringify(items));
        }
        
        function addExpiryItem() {
            var name = document.getElementById('expiryItemName').value.trim();
            var date = document.getElementById('expiryItemDate').value;
            
            if (!name || !date) {
                alert('Bitte Artikel und Verfallsdatum eingeben!');
                return;
            }
            
            var items = getExpiryItems();
            items.push({
                id: Date.now(),
                name: name,
                date: date,
                addedBy: currentUser ? currentUser.name : 'Unbekannt',
                addedAt: new Date().toISOString()
            });
            
            // Sort by date (earliest first)
            items.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveExpiryItems(items);
            
            document.getElementById('expiryItemName').value = '';
            document.getElementById('expiryItemDate').value = '';
            renderExpiryTracker();
        }
        
        function deleteExpiryItem(id) {
            if (!confirm('Eintrag löschen? (z.B. weil ersetzt oder entsorgt)')) return;
            var items = getExpiryItems().filter(x => x.id !== id);
            saveExpiryItems(items);
            renderExpiryTracker();
        }
        
        function renderExpiryTracker() {
            var items = getExpiryItems();
            var container = document.getElementById('expiryList');
            var badge = document.getElementById('expiryCount');
            
            badge.textContent = items.length;
            
            if (items.length === 0) {
                container.innerHTML = '<div class="expiry-empty">Keine Verfallsdaten eingetragen – Artikel hinzufügen wenn etwas bald abläuft!</div>';
                return;
            }
            
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            
            var html = items.map(function(item) {
                var expDate = new Date(item.date);
                var diffTime = expDate - today;
                var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                var urgencyClass = '';
                var daysText = '';
                
                if (diffDays < 0) {
                    urgencyClass = 'urgent';
                    daysText = 'ABGELAUFEN!';
                } else if (diffDays === 0) {
                    urgencyClass = 'urgent';
                    daysText = 'Heute!';
                } else if (diffDays <= 14) {
                    urgencyClass = 'urgent';
                    daysText = diffDays + ' Tag' + (diffDays !== 1 ? 'e' : '');
                } else if (diffDays <= 30) {
                    urgencyClass = 'warning';
                    daysText = diffDays + ' Tage';
                } else if (diffDays <= 60) {
                    urgencyClass = 'soon';
                    daysText = Math.ceil(diffDays / 7) + ' Wochen';
                } else {
                    daysText = Math.ceil(diffDays / 30) + ' Monate';
                }
                
                var dateFormatted = expDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
                var addedDate = new Date(item.addedAt).toLocaleDateString('de-DE');
                
                return '<div class="expiry-item ' + urgencyClass + '">' +
                    '<div class="expiry-item-info">' +
                        '<div class="expiry-item-name">' + item.name + '</div>' +
                        '<div class="expiry-item-date">Verfällt am: ' + dateFormatted + '</div>' +
                        '<div class="expiry-item-meta">Eingetragen von ' + item.addedBy + ' am ' + addedDate + '</div>' +
                    '</div>' +
                    '<span class="expiry-item-days">' + daysText + '</span>' +
                    '<button class="expiry-delete" onclick="deleteExpiryItem(' + item.id + ')" title="Löschen (wenn ersetzt)">' +
                        '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>' +
                    '</button>' +
                '</div>';
            }).join('');
            
            container.innerHTML = html;
        }
        
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return weekNo;
        }
        function isLastWeekOfMonth() {
            var now = new Date();
            var lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            var daysLeft = lastDay.getDate() - now.getDate();
            return daysLeft < 7;
        }
        function renderWochenChecklist() {
            const c = document.getElementById('wochenChecklistContainer');
            const lastWeek = isLastWeekOfMonth();
            let h = ''; wochenChecklistData.forEach(s => {
                if (s.isLastWeek && !lastWeek) return;
                h += `<div class="${s.isLastWeek ? 'section sunday-section' : 'section'}" data-section="${s.id}"><div class="section-header" onclick="toggleSection('${s.id}')"><div class="section-icon">${s.icon}</div><div class="section-info"><div class="section-title">${s.title}</div><div class="section-count" id="count-${s.id}">0 / ${s.items.length}</div></div><div class="section-toggle"><svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg></div></div><div class="section-content">${s.items.map((it, i) => {
                    const itemText = typeof it === 'object' ? it.text : it;
                    const docLink = typeof it === 'object' && it.doc ? `<a class="doc-link" href="docs/${it.doc}" target="_blank" title="Original-Checkliste öffnen" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg></a>` : '';
                    return `<div class="check-item"><div class="check-item-row"><span class="check-label" id="label-${s.id}-${i}">${itemText}</span>${docLink}<button class="comment-toggle" onclick="toggleWochenComment('${s.id}-${i}')" title="Kommentar hinzufügen"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12zM7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg></button><label class="toggle-switch"><input type="checkbox" data-key="${s.id}-${i}" onchange="handleWochenCheckChange(this)"><span class="toggle-slider"></span></label></div><div class="comment-field" id="wochen-comment-field-${s.id}-${i}"><textarea class="comment-input" id="wochen-comment-${s.id}-${i}" placeholder="Kommentar/Bemerkungen..." oninput="updateWochenCommentToggle('${s.id}-${i}')"></textarea></div></div>`;
                }).join('')}</div></div>`;
            });
            c.innerHTML = h;
            let tot = 0; wochenChecklistData.forEach(s => { if (!s.isLastWeek || lastWeek) tot += s.items.length; });
            document.getElementById('wochenTotalCount').textContent = tot;
        }
        function toggleWochenComment(key) { 
            const field = document.getElementById(`wochen-comment-field-${key}`);
            field.classList.toggle('show');
            if (field.classList.contains('show')) {
                document.getElementById(`wochen-comment-${key}`).focus();
            }
        }
        function updateWochenCommentToggle(key) {
            const input = document.getElementById(`wochen-comment-${key}`);
            const toggle = input.closest('.check-item').querySelector('.comment-toggle');
            const hasComment = input.value.trim().length > 0;
            toggle.classList.toggle('has-comment', hasComment);
            wochenCommentsState[key] = input.value;
        }
        function handleWochenCheckChange(cb) { wochenChecklistState[cb.dataset.key] = cb.checked; document.getElementById(`label-${cb.dataset.key}`).classList.toggle('checked', cb.checked); updateWochenProgress(); validateWochenForm(); }
        function updateWochenProgress() {
            const lastWeek = isLastWeekOfMonth();
            let ck = 0, tot = 0;
            wochenChecklistData.forEach(s => { if (s.isLastWeek && !lastWeek) return; let sc = 0; s.items.forEach((_, i) => { if (wochenChecklistState[`${s.id}-${i}`]) { ck++; sc++; } tot++; }); const c = document.getElementById(`count-${s.id}`); if (c) c.textContent = `${sc} / ${s.items.length}`; });
            document.getElementById('wochenProgressCount').textContent = ck;
            document.getElementById('wochenProgressFill').style.width = `${tot > 0 ? (ck / tot) * 100 : 0}%`;
        }
        function validateWochenForm() {
            const lastWeek = isLastWeekOfMonth();
            let all = true;
            const employeeName = document.getElementById('wochenEmployeeName').value.trim();
            wochenChecklistData.forEach(s => { if (s.isLastWeek && !lastWeek) return; s.items.forEach((_, i) => { if (!wochenChecklistState[`${s.id}-${i}`]) all = false; }); });
            document.getElementById('wochenSubmitBtn').disabled = !wochenSignatureData || !all || !employeeName;
        }
        function setupWochenSignatureCanvas() {
            var canvas = document.getElementById('wochenSignatureCanvas');
            var cont = document.getElementById('wochenSignatureContainer');
            var ctx = canvas.getContext('2d');
            var isDrawing = false;
            var canvasReady = false;
            
            function initCanvas() {
                var rect = canvas.getBoundingClientRect();
                var w = rect.width > 0 ? rect.width : 300;
                var h = rect.height > 0 ? rect.height : 200;
                canvas.width = w * 2;
                canvas.height = h * 2;
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(2, 2);
                ctx.strokeStyle = '#ffffff';
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.clearRect(0, 0, w, h);
                canvasReady = true;
            }
            initCanvas();
            
            function getXY(e) {
                var rect = canvas.getBoundingClientRect();
                var clientX, clientY;
                if (e.touches && e.touches[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { x: clientX - rect.left, y: clientY - rect.top };
            }
            
            function startDraw(e) {
                e.preventDefault();
                if (!canvasReady) initCanvas();
                isDrawing = true;
                var pos = getXY(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            }
            
            function doDraw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                var pos = getXY(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                cont.classList.add('has-signature');
                wochenSignatureData = canvas.toDataURL('image/png');
                validateWochenForm();
            }
            
            function endDraw() { isDrawing = false; }
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', doDraw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('mouseleave', endDraw);
            canvas.addEventListener('touchstart', startDraw, { passive: false });
            canvas.addEventListener('touchmove', doDraw, { passive: false });
            canvas.addEventListener('touchend', endDraw);
            
            document.getElementById('wochenClearSignature').addEventListener('click', function() {
                initCanvas();
                cont.classList.remove('has-signature');
                wochenSignatureData = null;
                validateWochenForm();
            });
        }

        // PDF EXPORT
        function exportPDF(type) {
            try {
                if (!window.jspdf) {
                    alert('PDF Bibliothek nicht geladen. Bitte Seite neu laden.');
                    return;
                }
                
                var theChecklistData, theChecklistState, theCommentsState, theSignatureData, employeeName, docId, pdfTitle, headerColor;
                
                if (type === 'ambulanz') {
                    theChecklistData = checklistData;
                    theChecklistState = checklistState;
                    theCommentsState = commentsState;
                    theSignatureData = signatureData;
                    employeeName = document.getElementById('employeeName').value || 'Nicht angegeben';
                    docId = '054_CL_Ambulanzcheck';
                    pdfTitle = 'Täglicher Ambulanzcheck';
                    headerColor = [196, 30, 58];
                } else if (type === 'mpg') {
                    theChecklistData = mpgChecklistData;
                    theChecklistState = mpgChecklistState;
                    theCommentsState = mpgCommentsState;
                    theSignatureData = mpgSignatureData;
                    employeeName = document.getElementById('mpgEmployeeName').value || 'Nicht angegeben';
                    docId = '054_CL_Täglicher_MPG-Check_RTW';
                    pdfTitle = 'Täglicher MPG-Check RTW';
                    headerColor = [30, 100, 200];
                } else if (type === 'wochen') {
                    theChecklistData = wochenChecklistData;
                    theChecklistState = wochenChecklistState;
                    theCommentsState = wochenCommentsState;
                    theSignatureData = wochenSignatureData;
                    employeeName = document.getElementById('wochenEmployeeName').value || 'Nicht angegeben';
                    docId = '054_CL_Woechentlicher_RTW_Check_1-83-1';
                    pdfTitle = 'Woechentlicher RTW Check';
                    headerColor = [230, 126, 34];
                } else if (type === 'reinigung') {
                    // Special PDF export for Reinigungsplan
                    exportReinigungPDF();
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const sun = new Date().getDay() === 0;
                const lastWeek = isLastWeekOfMonth();
                const dateStr = new Date().toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
                const shortDate = new Date().toLocaleDateString('de-DE');
                const kw = getWeekNumber(new Date());
                
                let y = 20;
                
                // Header line (document ID)
                doc.setFontSize(8);
                doc.setTextColor(120, 120, 120);
                doc.setFont('helvetica', 'normal');
                doc.text(docId, 195, 10, { align: 'right' });
                
                // Main Header
                doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
                doc.rect(0, 15, 210, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(pdfTitle, 105, 30, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Gesundheitszentrum Mercedes-Benz Rastatt', 105, 40, { align: 'center' });
                
                y = 55;
                
                // Meta info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                if (type === 'wochen') {
                    doc.text('KW:', 20, y);
                    doc.text('Mitarbeiter:', 110, y);
                    doc.setFont('helvetica', 'normal');
                    doc.text(kw.toString(), 35, y);
                } else {
                    doc.text('Datum:', 20, y);
                    doc.text('Mitarbeiter:', 110, y);
                    doc.setFont('helvetica', 'normal');
                    doc.text(dateStr, 40, y);
                }
                doc.text(employeeName, 140, y);
                
                y += 12;
                
                // Checklist sections
                theChecklistData.forEach(function(section) {
                    if (section.isSunday && !sun) return;
                    if (section.isLastWeek && !lastWeek) return;
                    
                    if (y > 245) {
                        addFooter(doc, docId, shortDate, employeeName);
                        doc.addPage();
                        y = 25;
                        // Header on new page
                        doc.setFontSize(8);
                        doc.setTextColor(120, 120, 120);
                        doc.text(docId, 195, 10, { align: 'right' });
                        doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
                        doc.rect(0, 12, 210, 8, 'F');
                    }
                    
                    // Section header
                    doc.setFillColor(50, 50, 50);
                    doc.rect(15, y - 4, 180, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'bold');
                    doc.text(section.title, 20, y + 1);
                    y += 10;
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    
                    section.items.forEach(function(item, i) {
                        if (y > 250) {
                            addFooter(doc, docId, shortDate, employeeName);
                            doc.addPage();
                            y = 25;
                            doc.setFontSize(8);
                            doc.setTextColor(120, 120, 120);
                            doc.text(docId, 195, 10, { align: 'right' });
                            doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
                            doc.rect(0, 12, 210, 8, 'F');
                        }
                        
                        var key = section.id + '-' + i;
                        var checked = theChecklistState[key];
                        var comment = theCommentsState[key] || '';
                        var itemText = typeof item === 'object' ? item.text : item;
                        
                        // Checkbox
                        if (checked) {
                            doc.setFillColor(46, 204, 113);
                            doc.rect(20, y - 3, 4, 4, 'F');
                            doc.setDrawColor(255, 255, 255);
                            doc.setLineWidth(0.5);
                            doc.line(21, y - 0.8, 22, y + 0.3);
                            doc.line(22, y + 0.3, 23.5, y - 2.2);
                        } else {
                            doc.setDrawColor(150, 150, 150);
                            doc.setFillColor(245, 245, 245);
                            doc.rect(20, y - 3, 4, 4, 'FD');
                        }
                        
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.1);
                        doc.setTextColor(checked ? 80 : 0, checked ? 80 : 0, checked ? 80 : 0);
                        
                        var displayItem = itemText.length > 60 ? itemText.substring(0, 57) + '...' : itemText;
                        doc.text(displayItem, 27, y);
                        y += 5;
                        
                        if (comment) {
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            doc.setFont('helvetica', 'italic');
                            doc.text('→ ' + comment, 27, y);
                            doc.setFont('helvetica', 'normal');
                            doc.setFontSize(9);
                            y += 4;
                        }
                        y += 1;
                    });
                    y += 4;
                });
                
                // Signature
                if (y > 200) {
                    addFooter(doc, docId, shortDate, employeeName);
                    doc.addPage();
                    y = 25;
                    doc.setFontSize(8);
                    doc.setTextColor(120, 120, 120);
                    doc.text(docId, 195, 10, { align: 'right' });
                }
                
                y += 8;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('Unterschrift:', 20, y);
                y += 6;
                
                if (theSignatureData && theSignatureData.length > 100) {
                    doc.setDrawColor(150, 150, 150);
                    doc.setFillColor(40, 40, 40);
                    doc.rect(20, y, 70, 30, 'FD');
                    try {
                        doc.addImage(theSignatureData, 'PNG', 22, y + 2, 66, 26);
                    } catch(imgErr) {
                        console.error('Signature error:', imgErr);
                    }
                    y += 33;
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(60, 60, 60);
                    doc.text(employeeName.toUpperCase(), 55, y, { align: 'center' });
                } else {
                    doc.setDrawColor(150, 150, 150);
                    doc.line(20, y + 18, 90, y + 18);
                    y += 22;
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(60, 60, 60);
                    doc.text(employeeName.toUpperCase(), 55, y, { align: 'center' });
                }
                
                // Add footer to all pages
                var pageCount = doc.internal.getNumberOfPages();
                for (var p = 1; p <= pageCount; p++) {
                    doc.setPage(p);
                    addFooter(doc, docId, shortDate, employeeName, p, pageCount);
                }
                
                // Download
                var filePrefix;
                if (type === 'ambulanz') {
                    filePrefix = 'Ambulanzcheck_';
                } else if (type === 'mpg') {
                    filePrefix = 'MPGCheck_';
                } else if (type === 'wochen') {
                    filePrefix = 'Wochencheck_KW' + kw + '_';
                }
                var fileName = filePrefix + new Date().toISOString().split('T')[0] + '_' + employeeName.replace(/\s+/g, '_') + '.pdf';
                
                var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                if (isIOS) {
                    var pdfBlob = doc.output('blob');
                    var blobUrl = URL.createObjectURL(pdfBlob);
                    window.open(blobUrl, '_blank');
                } else {
                    doc.save(fileName);
                }
                
            } catch(err) {
                alert('PDF Fehler: ' + err.message);
                console.error(err);
            }
        }
        
        function addFooter(doc, docId, date, employee, pageNum, totalPages) {
            var y = 282;
            
            // Footer line
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.3);
            doc.line(15, y - 5, 195, y - 5);
            
            // Footer table
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            doc.setFont('helvetica', 'normal');
            
            // Row 1
            doc.text('bearbeitet von: ' + employee, 15, y);
            doc.text('bearbeitet am: ' + date, 80, y);
            doc.text('054_HR/PHB', 145, y);
            
            // Row 2
            y += 4;
            doc.text('freigegeben von:', 15, y);
            doc.text('freigegeben am:', 80, y);
            if (pageNum && totalPages) {
                doc.text('Seite ' + pageNum + '/' + totalPages, 145, y);
            }
        }

        // SUBMIT CHECK
        function submitCheck(type) {
            var theChecklistData, theChecklistState, theCommentsState, theSignatureData, employeeName, btn, storageKey, checkTitle, progressCountId;
            var lastWeek = isLastWeekOfMonth();
            
            if (type === 'ambulanz') {
                theChecklistData = checklistData;
                theChecklistState = checklistState;
                theCommentsState = commentsState;
                theSignatureData = signatureData;
                employeeName = document.getElementById('employeeName').value || 'Nicht angegeben';
                btn = document.getElementById('submitBtn');
                storageKey = 'ambulanzcheck_archive';
                checkTitle = 'Ambulanzcheck';
                progressCountId = 'progressCount';
            } else if (type === 'mpg') {
                theChecklistData = mpgChecklistData;
                theChecklistState = mpgChecklistState;
                theCommentsState = mpgCommentsState;
                theSignatureData = mpgSignatureData;
                employeeName = document.getElementById('mpgEmployeeName').value || 'Nicht angegeben';
                btn = document.getElementById('mpgSubmitBtn');
                storageKey = 'mpgcheck_archive';
                checkTitle = 'MPG-Check RTW';
                progressCountId = 'mpgProgressCount';
            } else if (type === 'wochen') {
                theChecklistData = wochenChecklistData;
                theChecklistState = wochenChecklistState;
                theCommentsState = wochenCommentsState;
                theSignatureData = wochenSignatureData;
                employeeName = document.getElementById('wochenEmployeeName').value || 'Nicht angegeben';
                btn = document.getElementById('wochenSubmitBtn');
                storageKey = 'wochencheck_archive';
                checkTitle = 'RTW Wochencheck';
                progressCountId = 'wochenProgressCount';
            } else if (type === 'reinigung') {
                // Special handling for Reinigungsplan
                btn = document.getElementById('reinigungSubmitBtn');
                btn.disabled = true;
                btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/></svg> Speichern...';
                
                var now = new Date(), ds = now.toISOString().split('T')[0], ts = now.toLocaleTimeString('de-DE');
                var kw = getWeekNumber(now);
                
                // Build reinigung results
                var reinigungResults = {};
                Object.entries(reinigungsPlanData).forEach(function([day, tasks]) {
                    reinigungResults[day] = [];
                    tasks.forEach(function(task, idx) {
                        var taskId = day + '-' + idx;
                        var state = reinigungState[taskId] || {};
                        reinigungResults[day].push({
                            schicht: task.schicht,
                            bereich: task.bereich,
                            umfang: task.umfang,
                            noSign: task.noSign || false,
                            checked: state.checked || false,
                            name: state.name || '',
                            timestamp: state.timestamp || '',
                            signature: state.signature || null
                        });
                    });
                });
                
                var data = {
                    id: Date.now(),
                    docId: getNextDocId('reinigung'),
                    type: 'reinigung',
                    meta: {
                        datum: ds,
                        uhrzeit: ts,
                        mitarbeiter: 'Siehe Einträge',
                        user: currentUser ? currentUser.name : 'Unbekannt',
                        userKuerzel: currentUser ? currentUser.kuerzel : 'UNKNOWN',
                        standort: 'Mercedes-Benz Rastatt',
                        kw: kw
                    },
                    reinigung: reinigungResults,
                    exported: false
                };
                // Manipulationsschutz: Checksum generieren
                data.checksum = generateChecksum({ meta: data.meta, reinigung: data.reinigung });
                
                try {
                    var archive = JSON.parse(localStorage.getItem('reinigung_archive') || '[]');
                    archive.unshift(data);
                    if (archive.length > 100) archive = archive.slice(0, 100);
                    localStorage.setItem('reinigung_archive', JSON.stringify(archive));
                    
                    // Clear current week's state after archiving
                    localStorage.removeItem('reinigung_current_kw' + kw);
                    reinigungState = {};
                    
                    // Audit Log
                    addAuditEntry('CHECK_ABGESCHLOSSEN', `Reinigungsplan KW ${kw} abgeschlossen (${data.docId})`);
                    
                    // Store for share function
                    lastSavedCheck = {
                        type: 'reinigung',
                        title: 'Reinigungsplan',
                        data: data,
                        storageKey: 'reinigung_archive'
                    };
                    
                    document.getElementById('successDate').textContent = 'KW ' + kw + ' / ' + ds;
                    document.getElementById('successEmployee').textContent = 'Siehe Einzeleinträge';
                    document.getElementById('successItems').textContent = document.getElementById('reinigungProgressCount').textContent;
                    document.querySelector('.success-message').textContent = 'Der Reinigungsplan wurde erfolgreich abgeschlossen.';
                    document.getElementById('successDocId').textContent = data.docId;
                    showScreen('success');
                } catch (e) {
                    alert('Fehler beim Speichern: ' + e.message);
                    btn.disabled = false;
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Woche abschließen & speichern';
                }
                return;
            }
            
            btn.disabled = true; 
            btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/></svg> Speichern...';
            
            var now = new Date(), ds = now.toISOString().split('T')[0], ts = now.toLocaleTimeString('de-DE'), sun = now.getDay() === 0;
            var kw = getWeekNumber(now);
            var res = {}; 
            theChecklistData.forEach(function(s) { 
                if (s.isSunday && !sun) return;
                if (s.isLastWeek && !lastWeek) return;
                res[s.title] = {}; 
                s.items.forEach(function(it, i) { 
                    var key = s.id + '-' + i;
                    var itemText = typeof it === 'object' ? it.text : it;
                    var comment = theCommentsState[key] || ''; 
                    res[s.title][itemText] = { checked: theChecklistState[key] ? '✓' : '✗', comment: comment }; 
                }); 
            });
            
            var data = { 
                id: Date.now(),
                docId: getNextDocId(type),
                type: type,
                meta: { 
                    datum: ds, 
                    uhrzeit: ts, 
                    mitarbeiter: employeeName, 
                    user: currentUser ? currentUser.name : 'Unbekannt',
                    userKuerzel: currentUser ? currentUser.kuerzel : 'UNKNOWN',
                    standort: 'Mercedes-Benz Rastatt',
                    kw: type === 'wochen' ? kw : null
                }, 
                checkliste: res, 
                unterschrift: theSignatureData,
                exported: false
            };
            // Manipulationsschutz: Checksum generieren
            data.checksum = generateChecksum({ meta: data.meta, checkliste: data.checkliste });
            
            try {
                var archive = JSON.parse(localStorage.getItem(storageKey) || '[]');
                archive.unshift(data);
                if (archive.length > 100) archive = archive.slice(0, 100);
                localStorage.setItem(storageKey, JSON.stringify(archive));
                
                // Audit Log
                addAuditEntry('CHECK_ABGESCHLOSSEN', `${checkTitle} abgeschlossen (${data.docId})`);
                
                // Store for share function
                lastSavedCheck = {
                    type: type,
                    title: checkTitle,
                    data: data,
                    storageKey: storageKey
                };
                
                document.getElementById('successDate').textContent = type === 'wochen' ? 'KW ' + kw + ' / ' + ds : ds + ' ' + ts;
                document.getElementById('successEmployee').textContent = employeeName;
                document.getElementById('successItems').textContent = document.getElementById(progressCountId).textContent;
                document.querySelector('.success-message').textContent = 'Der ' + checkTitle + ' wurde erfolgreich abgeschlossen.';
                document.getElementById('successDocId').textContent = data.docId;
                showScreen('success');
            } catch (e) { 
                alert('Fehler beim Speichern: ' + e.message); 
                btn.disabled = false; 
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Check abschließen & speichern'; 
            }
        }

        // REINIGUNGSPLAN
        function initReinigungsplan() {
            const kw = getWeekNumber(new Date());
            document.getElementById('reinigungKW').textContent = 'KW ' + kw;
            
            // Load saved state from localStorage (persists through the week)
            const savedState = localStorage.getItem('reinigung_current_kw' + kw);
            if (savedState) {
                try {
                    reinigungState = JSON.parse(savedState);
                } catch (e) {
                    reinigungState = {};
                }
            } else {
                reinigungState = {};
            }
            
            // Count total tasks (excluding noSign)
            let total = 0;
            Object.values(reinigungsPlanData).forEach(tasks => {
                tasks.forEach(task => { if (!task.noSign) total++; });
            });
            document.getElementById('reinigungTotalCount').textContent = total;
            
            renderReinigungsplan();
            updateReinigungProgress();
            validateReinigungForm();
        }
        
        function saveReinigungState() {
            const kw = getWeekNumber(new Date());
            localStorage.setItem('reinigung_current_kw' + kw, JSON.stringify(reinigungState));
        }
        
        function renderReinigungsplan() {
            const container = document.getElementById('reinigungContainer');
            const dayNames = { montag: 'Montag', dienstag: 'Dienstag', mittwoch: 'Mittwoch', donnerstag: 'Donnerstag', freitag: 'Freitag' };
            const dayIcon = '<svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zm0-12H5V6h14v2z"/></svg>';
            
            let html = '';
            Object.entries(reinigungsPlanData).forEach(([day, tasks]) => {
                const taskCount = tasks.filter(t => !t.noSign).length;
                html += `<div class="reinigung-day">
                    <div class="reinigung-day-header">
                        <div class="reinigung-day-icon">${dayIcon}</div>
                        <div class="reinigung-day-name">${dayNames[day]}</div>
                        <div class="reinigung-day-count">${taskCount} Aufgaben</div>
                    </div>`;
                
                tasks.forEach((task, idx) => {
                    const taskId = `${day}-${idx}`;
                    const schichtClass = task.schicht.toLowerCase().replace('.', '').replace(' ', '');
                    const hasWomit = task.womit && task.womit.trim() !== '';
                    const state = reinigungState[taskId];
                    const isCompleted = state && state.checked && state.name && state.signature;
                    
                    html += `<div class="reinigung-task ${isCompleted ? 'completed' : ''}" id="task-${taskId}">
                        <div class="reinigung-task-header">
                            <span class="schicht-badge ${schichtClass}">${task.schicht}</span>
                            <span class="reinigung-bereich">${task.bereich}</span>
                            ${hasWomit ? `<button class="reinigung-info-btn" onclick="showInfoModal('${encodeURIComponent(task.womit)}')" title="Reinigungsmittel"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></button>` : ''}
                        </div>
                        <div class="reinigung-task-body">
                            <div class="reinigung-umfang">${task.umfang.replace(/\n/g, '<br>')}</div>
                            ${task.hinweis ? `<div style="font-size:12px;color:var(--orange);margin-bottom:12px;">* ${task.hinweis}</div>` : ''}
                            ${task.noSign ? `<div class="reinigung-no-sign">Keine Dokumentation erforderlich</div>` : 
                                (isCompleted ? `
                                    <div class="reinigung-done-info">
                                        <div class="reinigung-done-row">
                                            <span class="reinigung-done-label">Name:</span>
                                            <span class="reinigung-done-value">${state.name}</span>
                                        </div>
                                        <div class="reinigung-done-row">
                                            <span class="reinigung-done-label">Zeit:</span>
                                            <span class="reinigung-done-value">${state.timestamp}</span>
                                        </div>
                                        <div class="reinigung-done-sig">
                                            <img src="${state.signature}" alt="Unterschrift">
                                        </div>
                                    </div>
                                ` : `
                                    <button class="reinigung-sign-btn" onclick="openSignModal('${taskId}')">
                                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                        Erledigt + Unterschreiben
                                    </button>
                                `)
                            }
                        </div>
                    </div>`;
                });
                html += '</div>';
            });
            container.innerHTML = html;
        }
        
        // Sign Modal State
        var currentSignTaskId = null;
        var signModalSignature = null;
        
        function openSignModal(taskId) {
            currentSignTaskId = taskId;
            signModalSignature = null;
            
            // Find task data
            const parts = taskId.split('-');
            const day = parts[0];
            const idx = parseInt(parts[1]);
            const task = reinigungsPlanData[day][idx];
            const dayNames = { montag: 'Montag', dienstag: 'Dienstag', mittwoch: 'Mittwoch', donnerstag: 'Donnerstag', freitag: 'Freitag' };
            
            // Populate modal
            document.getElementById('signModalTitle').textContent = task.bereich;
            document.getElementById('signModalSubtitle').textContent = dayNames[day] + ' • Schicht: ' + task.schicht;
            document.getElementById('signModalTask').innerHTML = task.umfang.replace(/\n/g, '<br>');
            // Auto-fill name with current user
            document.getElementById('signModalName').value = currentUser ? currentUser.name : '';
            signModalSignature = null;
            document.getElementById('signModalConfirm').disabled = true;
            document.getElementById('signModalCanvasWrap').classList.remove('has-signature');
            
            // Show modal
            document.getElementById('signModal').classList.add('active');
            
            // Setup canvas after modal is visible
            setTimeout(setupSignModalCanvas, 100);
            
            // Validate (in case name is pre-filled)
            setTimeout(validateSignModal, 150);
        }
        
        function closeSignModal() {
            document.getElementById('signModal').classList.remove('active');
            currentSignTaskId = null;
            signModalSignature = null;
        }
        
        function setupSignModalCanvas() {
            const container = document.getElementById('signModalCanvasWrap');
            if (!container) return;
            
            // Remove old canvas and create fresh one
            container.innerHTML = '<canvas class="sign-modal-canvas" id="signModalCanvas"></canvas><span class="sign-modal-canvas-placeholder">Hier unterschreiben</span><button class="sign-modal-canvas-clear" onclick="clearSignModal()">Löschen</button>';
            
            const canvas = document.getElementById('signModalCanvas');
            const ctx = canvas.getContext('2d');
            const rect = container.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = 120;
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            let drawing = false;
            let lastX = 0, lastY = 0;
            
            function getPos(e) {
                const r = canvas.getBoundingClientRect();
                const t = e.touches ? e.touches[0] : e;
                return { x: t.clientX - r.left, y: t.clientY - r.top };
            }
            
            canvas.onmousedown = function(e) {
                drawing = true;
                const p = getPos(e);
                lastX = p.x;
                lastY = p.y;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            };
            
            canvas.onmousemove = function(e) {
                if (!drawing) return;
                const p = getPos(e);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                lastX = p.x;
                lastY = p.y;
                container.classList.add('has-signature');
            };
            
            canvas.onmouseup = function() {
                if (drawing) {
                    drawing = false;
                    signModalSignature = canvas.toDataURL();
                    validateSignModal();
                }
            };
            
            canvas.onmouseleave = function() {
                if (drawing) {
                    drawing = false;
                    signModalSignature = canvas.toDataURL();
                    validateSignModal();
                }
            };
            
            canvas.ontouchstart = function(e) {
                e.preventDefault();
                drawing = true;
                const p = getPos(e);
                lastX = p.x;
                lastY = p.y;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
            };
            
            canvas.ontouchmove = function(e) {
                e.preventDefault();
                if (!drawing) return;
                const p = getPos(e);
                ctx.lineTo(p.x, p.y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                lastX = p.x;
                lastY = p.y;
                container.classList.add('has-signature');
            };
            
            canvas.ontouchend = function() {
                if (drawing) {
                    drawing = false;
                    signModalSignature = canvas.toDataURL();
                    validateSignModal();
                }
            };
        }
        
        function clearSignModal() {
            const canvas = document.getElementById('signModalCanvas');
            const container = document.getElementById('signModalCanvasWrap');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#2a2a2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            container.classList.remove('has-signature');
            signModalSignature = null;
            validateSignModal();
        }
        
        function validateSignModal() {
            const name = document.getElementById('signModalName').value.trim();
            const hasSignature = signModalSignature !== null;
            document.getElementById('signModalConfirm').disabled = !(name && hasSignature);
        }
        
        function confirmSignModal() {
            if (!currentSignTaskId) return;
            
            const name = document.getElementById('signModalName').value.trim();
            if (!name || !signModalSignature) return;
            
            const now = new Date();
            const timestamp = now.toLocaleString('de-DE', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
            
            // Save to state
            reinigungState[currentSignTaskId] = {
                checked: true,
                name: name,
                timestamp: timestamp,
                signature: signModalSignature
            };
            
            // Persist to localStorage
            saveReinigungState();
            
            // Close modal and re-render
            closeSignModal();
            renderReinigungsplan();
            updateReinigungProgress();
            validateReinigungForm();
        }
        
        function updateReinigungProgress() {
            let checked = 0, total = 0;
            Object.entries(reinigungsPlanData).forEach(([day, tasks]) => {
                tasks.forEach((task, idx) => {
                    if (!task.noSign) {
                        total++;
                        const taskId = `${day}-${idx}`;
                        if (reinigungState[taskId] && reinigungState[taskId].checked && reinigungState[taskId].name && reinigungState[taskId].signature) {
                            checked++;
                        }
                    }
                });
            });
            const pct = total > 0 ? Math.round((checked / total) * 100) : 0;
            document.getElementById('reinigungProgressFill').style.width = pct + '%';
            document.getElementById('reinigungProgressCount').textContent = checked;
        }
        
        function validateReinigungForm() {
            let allComplete = true;
            Object.entries(reinigungsPlanData).forEach(([day, tasks]) => {
                tasks.forEach((task, idx) => {
                    if (!task.noSign) {
                        const taskId = `${day}-${idx}`;
                        if (!reinigungState[taskId] || !reinigungState[taskId].checked || !reinigungState[taskId].name || !reinigungState[taskId].signature) {
                            allComplete = false;
                        }
                    }
                });
            });
            document.getElementById('reinigungSubmitBtn').disabled = !allComplete;
        }
        
        function showInfoModal(womitEncoded) {
            const womit = decodeURIComponent(womitEncoded);
            document.getElementById('infoModalText').innerHTML = womit.replace(/\n/g, '<br>');
            document.getElementById('infoModal').classList.add('active');
        }
        
        function closeInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }
        
        function exportReinigungPDF() {
            try {
                if (!window.jspdf) {
                    alert('PDF Bibliothek nicht geladen. Bitte Seite neu laden.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const now = new Date();
                const kw = getWeekNumber(now);
                const dateStr = now.toLocaleDateString('de-DE');
                const dayNames = { montag: 'Montag', dienstag: 'Dienstag', mittwoch: 'Mittwoch', donnerstag: 'Donnerstag', freitag: 'Freitag' };
                
                let y = 20;
                
                // Header
                doc.setFontSize(8);
                doc.setTextColor(120, 120, 120);
                doc.text('054_FB_Woechentlicher_Reinigungsplan', 195, 10, { align: 'right' });
                
                doc.setFillColor(26, 188, 156);
                doc.rect(0, 15, 210, 30, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('Woechentlicher Reinigungsplan', 105, 30, { align: 'center' });
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Gesundheitszentrum Mercedes-Benz Rastatt', 105, 40, { align: 'center' });
                
                y = 55;
                
                // Meta info
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text('KW:', 20, y);
                doc.setFont('helvetica', 'normal');
                doc.text(kw.toString(), 35, y);
                doc.setFont('helvetica', 'bold');
                doc.text('Erstellt:', 100, y);
                doc.setFont('helvetica', 'normal');
                doc.text(dateStr, 125, y);
                
                y += 12;
                
                // Content by day
                Object.entries(reinigungsPlanData).forEach(function([day, tasks]) {
                    if (y > 250) {
                        doc.addPage();
                        y = 25;
                        doc.setFontSize(8);
                        doc.setTextColor(120, 120, 120);
                        doc.text('054_FB_Woechentlicher_Reinigungsplan', 195, 10, { align: 'right' });
                        doc.setFillColor(26, 188, 156);
                        doc.rect(0, 12, 210, 8, 'F');
                    }
                    
                    // Day header
                    doc.setFillColor(26, 188, 156);
                    doc.rect(15, y - 4, 180, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text(dayNames[day] || day, 20, y + 1);
                    y += 10;
                    
                    tasks.forEach(function(task, idx) {
                        if (y > 250) {
                            doc.addPage();
                            y = 25;
                        }
                        
                        var taskId = day + '-' + idx;
                        var state = reinigungState[taskId] || {};
                        var checked = state.checked ? '✓' : (task.noSign ? '-' : '○');
                        
                        doc.setTextColor(0, 0, 0);
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.text(checked + '  [' + task.schicht + '] ' + task.bereich, 20, y);
                        doc.setFont('helvetica', 'normal');
                        y += 5;
                        
                        // Umfang (first line only)
                        doc.setTextColor(80, 80, 80);
                        doc.setFontSize(8);
                        var umfangLine = task.umfang.split('\n')[0];
                        if (umfangLine.length > 80) umfangLine = umfangLine.substring(0, 80) + '...';
                        doc.text(umfangLine, 25, y);
                        y += 4;
                        
                        if (!task.noSign && state.name) {
                            doc.setTextColor(60, 60, 60);
                            doc.text('Name: ' + state.name + '  |  ' + (state.timestamp || ''), 25, y);
                            y += 4;
                            
                            // Individual signature
                            if (state.signature) {
                                try {
                                    doc.addImage(state.signature, 'PNG', 25, y, 40, 15);
                                    y += 18;
                                } catch (sigErr) {
                                    console.warn('Signatur konnte nicht geladen werden:', sigErr);
                                }
                            }
                        }
                        y += 3;
                    });
                    y += 5;
                });
                
                // Footer
                var pageCount = doc.internal.getNumberOfPages();
                for (var i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(120, 120, 120);
                    doc.text('Seite ' + i + ' von ' + pageCount, 105, 290, { align: 'center' });
                }
                
                doc.save('Reinigungsplan_KW' + kw + '_' + dateStr.replace(/\./g, '-') + '.pdf');
            } catch (e) {
                console.error('PDF Export Error:', e);
                alert('Fehler beim PDF Export: ' + e.message);
            }
        }

        // ARCHIVE
        function loadArchive() {
            const c = document.getElementById('archiveContainer');
            c.innerHTML = '<div class="archive-loading">Lade...</div>';
            
            try {
                const ambulanzArchive = JSON.parse(localStorage.getItem('ambulanzcheck_archive') || '[]').map(x => ({...x, type: 'ambulanz'}));
                const mpgArchive = JSON.parse(localStorage.getItem('mpgcheck_archive') || '[]').map(x => ({...x, type: 'mpg'}));
                const wochenArchive = JSON.parse(localStorage.getItem('wochencheck_archive') || '[]').map(x => ({...x, type: 'wochen'}));
                const reinigungArchive = JSON.parse(localStorage.getItem('reinigung_archive') || '[]').map(x => ({...x, type: 'reinigung'}));
                const archive = [...ambulanzArchive, ...mpgArchive, ...wochenArchive, ...reinigungArchive].sort((a, b) => b.id - a.id);
                
                if (!archive.length) { 
                    c.innerHTML = '<div class="archive-empty"><div class="archive-empty-icon"><svg viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27z"/></svg></div><p class="archive-empty-text">Noch keine Checks gespeichert.</p></div>'; 
                    return; 
                }
                
                c.innerHTML = archive.map(x => {
                    const d = x.meta.datum;
                    const emp = x.meta.mitarbeiter || '';
                    const time = x.meta.uhrzeit;
                    const kw = x.meta.kw;
                    let badgeColor, typeName;
                    if (x.type === 'ambulanz') {
                        badgeColor = '#c41e3a';
                        typeName = 'Ambulanz';
                    } else if (x.type === 'mpg') {
                        badgeColor = '#1e64c4';
                        typeName = 'MPG-RTW';
                    } else if (x.type === 'wochen') {
                        badgeColor = '#e67e22';
                        typeName = 'Woche' + (kw ? ' KW' + kw : '');
                    } else if (x.type === 'reinigung') {
                        badgeColor = '#1abc9c';
                        typeName = 'Reinigung KW' + (kw || '');
                    }
                    return `<div class="archive-item" onclick="showCheckDetail(${x.id}, '${x.type}')">
                        <div class="archive-item-header">
                            <span class="archive-item-date">${d}</span>
                            <span class="archive-item-badge" style="background:${badgeColor}">${typeName}</span>
                        </div>
                        <div class="archive-item-details">
                            ${emp ? `<div class="archive-item-detail"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>${emp}</div>` : ''}
                            <div class="archive-item-detail"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>${time}</div>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { 
                c.innerHTML = '<div class="archive-empty"><p class="archive-empty-text">Fehler beim Laden.</p></div>'; 
            }
        }
        
        var currentArchiveType = 'ambulanz';
        function showCheckDetail(id, type) {
            try {
                currentArchiveType = type || 'ambulanz';
                let storageKey;
                if (currentArchiveType === 'ambulanz') {
                    storageKey = 'ambulanzcheck_archive';
                } else if (currentArchiveType === 'mpg') {
                    storageKey = 'mpgcheck_archive';
                } else if (currentArchiveType === 'wochen') {
                    storageKey = 'wochencheck_archive';
                } else if (currentArchiveType === 'reinigung') {
                    storageKey = 'reinigung_archive';
                }
                const archive = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const c = archive.find(x => x.id === id);
                if (!c) { alert('Check nicht gefunden'); return; }
                
                currentDetailId = id;
                currentArchivedCheck = { check: c, type: currentArchiveType, storageKey: storageKey }; // Store for email
                let typeName;
                if (currentArchiveType === 'ambulanz') {
                    typeName = 'Ambulanzcheck';
                } else if (currentArchiveType === 'mpg') {
                    typeName = 'MPG-Check RTW';
                } else if (currentArchiveType === 'wochen') {
                    typeName = 'RTW Wochencheck';
                } else if (currentArchiveType === 'reinigung') {
                    typeName = 'Reinigungsplan';
                }
                const dateDisplay = (currentArchiveType === 'wochen' || currentArchiveType === 'reinigung') && c.meta.kw ? `KW ${c.meta.kw} (${c.meta.datum})` : c.meta.datum;
                document.getElementById('detailTitle').textContent = `${typeName} vom ${dateDisplay}`;
                document.getElementById('detailSubtitle').textContent = `${c.meta.mitarbeiter || 'Siehe Einträge'} • ${c.meta.uhrzeit}`;
                
                // Show delete button only for admin
                document.getElementById('deleteCheckBtn').style.display = currentUser && currentUser.role === 'admin' ? 'flex' : 'none';
                // Show email button always
                document.getElementById('shareCheckBtn').style.display = 'flex';
                
                let h = '';
                
                if (currentArchiveType === 'reinigung' && c.reinigung) {
                    // Special rendering for Reinigungsplan
                    const dayNames = { montag: 'Montag', dienstag: 'Dienstag', mittwoch: 'Mittwoch', donnerstag: 'Donnerstag', freitag: 'Freitag' };
                    Object.entries(c.reinigung).forEach(([day, tasks]) => {
                        h += `<div class="detail-section"><div class="detail-section-title">${dayNames[day] || day}</div>`;
                        tasks.forEach(task => {
                            if (task.noSign) {
                                h += `<div class="detail-item"><span class="detail-item-label">[${task.schicht}] ${task.bereich}<br><small style="color:var(--text-muted);">${task.umfang.substring(0, 50)}...</small></span><span class="detail-item-value" style="color:var(--text-muted);">-</span></div>`;
                            } else {
                                const status = task.checked ? '✓' : '✗';
                                h += `<div class="detail-item" style="flex-direction:column;align-items:stretch;">
                                    <div style="display:flex;justify-content:space-between;align-items:center;">
                                        <span class="detail-item-label">[${task.schicht}] ${task.bereich}</span>
                                        <span class="detail-item-value ${task.checked ? 'success' : ''}">${status}</span>
                                    </div>
                                    <small style="color:var(--text-muted);margin-top:4px;">${task.name || 'Kein Name'} • ${task.timestamp || '--:--'}</small>
                                    ${task.signature ? `<div style="margin-top:8px;background:var(--bg-input);border-radius:6px;padding:4px;"><img src="${task.signature}" style="width:100%;height:40px;object-fit:contain;" alt="Unterschrift"></div>` : ''}
                                </div>`;
                            }
                        });
                        h += '</div>';
                    });
                } else if (c.checkliste) {
                    Object.entries(c.checkliste).forEach(([sec, items]) => { 
                        h += `<div class="detail-section"><div class="detail-section-title">${sec}</div>`; 
                        Object.entries(items).forEach(([it, val]) => { 
                            const isNewFormat = typeof val === 'object';
                            const status = isNewFormat ? val.checked : val;
                            const comment = isNewFormat ? val.comment : '';
                            h += `<div class="detail-item"><span class="detail-item-label">${it}${comment ? `<br><small style="color:var(--text-muted);font-style:italic;">→ ${comment}</small>` : ''}</span><span class="detail-item-value ${status === '✓' ? 'success' : ''}">${status}</span></div>`; 
                        }); 
                        h += '</div>'; 
                    });
                }
                
                if (c.unterschrift) h += `<div class="detail-section"><div class="detail-section-title">Unterschrift</div><div class="detail-signature"><img src="${c.unterschrift}" alt=""></div></div>`;
                
                document.getElementById('detailContent').innerHTML = h;
                document.getElementById('detailModal').classList.add('active');
            } catch (e) { alert('Fehler: ' + e.message); }
        }
        
        function deleteCheck() {
            if (!confirm('Check wirklich löschen?\n\nDiese Aktion wird protokolliert.')) return;
            try {
                let storageKey, typeName;
                if (currentArchiveType === 'ambulanz') {
                    storageKey = 'ambulanzcheck_archive';
                    typeName = 'Ambulanzcheck';
                } else if (currentArchiveType === 'mpg') {
                    storageKey = 'mpgcheck_archive';
                    typeName = 'MPG-Check RTW';
                } else if (currentArchiveType === 'wochen') {
                    storageKey = 'wochencheck_archive';
                    typeName = 'RTW Wochencheck';
                } else if (currentArchiveType === 'reinigung') {
                    storageKey = 'reinigung_archive';
                    typeName = 'Reinigungsplan';
                }
                let archive = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const deletedItem = archive.find(x => x.id === currentDetailId);
                
                // Lösch-Protokoll eintragen
                if (deletedItem) {
                    addDeleteEntry(
                        deletedItem.docId || `LEGACY-${deletedItem.id}`,
                        typeName,
                        deletedItem.meta
                    );
                }
                
                archive = archive.filter(x => x.id !== currentDetailId);
                localStorage.setItem(storageKey, JSON.stringify(archive));
                document.getElementById('detailModal').classList.remove('active');
                loadArchive();
                updateExportBadge();
            } catch (e) { alert('Fehler: ' + e.message); }
        }

        // SHARE FUNKTIONEN (Web Share API für Teams/OneDrive)
        async function generatePDFBlob(type) {
            // Generate PDF and return as blob
            return new Promise((resolve) => {
                var theChecklistData, theChecklistState, theCommentsState, theSignatureData, employeeName, docId, pdfTitle, headerColor;
                
                if (type === 'ambulanz') {
                    theChecklistData = checklistData;
                    theChecklistState = checklistState;
                    theCommentsState = commentsState;
                    theSignatureData = signatureData;
                    employeeName = document.getElementById('employeeName').value || 'Nicht angegeben';
                    docId = '054-CL-001';
                    pdfTitle = 'Ambulanzcheck';
                    headerColor = [200, 30, 45];
                } else if (type === 'mpg') {
                    theChecklistData = mpgChecklistData;
                    theChecklistState = mpgChecklistState;
                    theCommentsState = mpgCommentsState;
                    theSignatureData = mpgSignatureData;
                    employeeName = document.getElementById('mpgEmployeeName').value || 'Nicht angegeben';
                    docId = '054-CL-002';
                    pdfTitle = 'MPG-Check RTW';
                    headerColor = [41, 128, 185];
                } else if (type === 'wochen') {
                    theChecklistData = wochenChecklistData;
                    theChecklistState = wochenChecklistState;
                    theCommentsState = wochenCommentsState;
                    theSignatureData = wochenSignatureData;
                    employeeName = document.getElementById('wochenEmployeeName').value || 'Nicht angegeben';
                    docId = '054-CL-003';
                    pdfTitle = 'RTW Wochencheck';
                    headerColor = [230, 126, 34];
                }
                
                var { jsPDF } = window.jspdf;
                var doc = new jsPDF();
                var now = new Date();
                var kw = getWeekNumber(now);
                var dateStr = now.toLocaleDateString('de-DE');
                var timeStr = now.toLocaleTimeString('de-DE');
                var shortDate = now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
                
                // Header
                doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
                doc.rect(0, 0, 210, 35, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text(pdfTitle, 15, 18);
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text('Mercedes-Benz Gesundheitszentrum Rastatt', 15, 28);
                doc.setFontSize(10);
                if (type === 'wochen') {
                    doc.text('KW ' + kw, 195, 15, { align: 'right' });
                } else {
                    doc.text(dateStr, 195, 15, { align: 'right' });
                }
                doc.text(timeStr, 195, 22, { align: 'right' });
                
                // Meta info
                doc.setTextColor(0, 0, 0);
                var y = 45;
                doc.setFontSize(10);
                if (type === 'wochen') {
                    doc.text('Kalenderwoche:', 15, y);
                    doc.text('KW ' + kw, 50, y);
                    doc.text('Mitarbeiter:', 110, y);
                } else {
                    doc.text('Datum:', 15, y);
                    doc.text(dateStr + ' ' + timeStr, 35, y);
                    doc.text('Mitarbeiter:', 110, y);
                }
                doc.text(employeeName, 140, y);
                
                y = 55;
                
                // Build content (simplified for blob generation)
                theChecklistData.forEach(function(s) {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y - 5, 180, 8, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text(s.title, 17, y);
                    y += 10;
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    
                    s.items.forEach(function(it, i) {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        var key = s.id + '-' + i;
                        var itemText = typeof it === 'object' ? it.text : it;
                        var checked = theChecklistState[key];
                        doc.text(checked ? '☑' : '☐', 17, y);
                        doc.text(itemText.substring(0, 80), 25, y);
                        y += 6;
                    });
                    y += 5;
                });
                
                // Signature
                if (theSignatureData) {
                    if (y > 240) {
                        doc.addPage();
                        y = 20;
                    }
                    y += 5;
                    doc.setFont('helvetica', 'bold');
                    doc.text('Unterschrift:', 15, y);
                    doc.addImage(theSignatureData, 'PNG', 15, y + 2, 50, 20);
                }
                
                resolve(doc.output('blob'));
            });
        }
        
        async function shareProtocol() {
            if (!lastSavedCheck) {
                alert('Kein Protokoll zum Teilen vorhanden.');
                return;
            }
            
            const check = lastSavedCheck;
            const meta = check.data.meta;
            const dateStr = meta.datum || new Date().toLocaleDateString('de-DE');
            const kwStr = meta.kw ? `KW ${meta.kw}` : '';
            const docId = check.data.docId || 'UNKNOWN';
            const fileName = `${docId}_${check.title.replace(/\s+/g, '_')}_${dateStr.replace(/\./g, '-')}.pdf`;
            
            try {
                // Generate PDF
                let pdfBlob;
                if (check.type === 'reinigung') {
                    exportReinigungPDF();
                    markAsExported(check.storageKey, check.data.id);
                    updateExportBadge();
                    // Open SharePoint after short delay
                    setTimeout(() => {
                        if (confirm('PDF heruntergeladen!\n\nSharePoint Archiv-Ordner öffnen?')) {
                            window.open(SHAREPOINT_ARCHIV_URL, '_blank');
                        }
                    }, 500);
                    return;
                } else {
                    pdfBlob = await generatePDFBlob(check.type);
                }
                
                const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
                
                // Check if Web Share API with files is supported (iOS)
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: `${check.title} - ${kwStr || dateStr}`,
                        text: `Dokument: ${docId}\nProtokoll: ${check.title}\nDatum: ${dateStr}\nMitarbeiter: ${meta.mitarbeiter || meta.user}`
                    });
                    markAsExported(check.storageKey, check.data.id);
                    updateExportBadge();
                } else {
                    // Fallback: Download + SharePoint öffnen
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                    markAsExported(check.storageKey, check.data.id);
                    updateExportBadge();
                    // Open SharePoint after short delay
                    setTimeout(() => {
                        if (confirm('PDF heruntergeladen!\n\nSharePoint Archiv-Ordner öffnen?')) {
                            window.open(SHAREPOINT_ARCHIV_URL, '_blank');
                        }
                    }, 500);
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Share error:', err);
                    alert('Teilen fehlgeschlagen. PDF wird heruntergeladen.');
                    exportPDF(check.type);
                }
            }
        }
        
        async function shareWeeklyExport() {
            const kw = getWeekNumber(new Date());
            const now = new Date();
            const weekStart = new Date(now);
            weekStart.setDate(now.getDate() - now.getDay() + 1);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);
            
            const storageKeys = ['ambulanzcheck_archive', 'mpgcheck_archive', 'wochencheck_archive', 'reinigung_archive'];
            const typeNames = { 'ambulanzcheck_archive': 'Ambulanzcheck', 'mpgcheck_archive': 'MPG-Check', 'wochencheck_archive': 'Wochencheck', 'reinigung_archive': 'Reinigungsplan' };
            
            let weeklyChecks = [];
            let summary = `WOCHENEXPORT KW ${kw}\n`;
            summary += `Zeitraum: ${weekStart.toLocaleDateString('de-DE')} - ${weekEnd.toLocaleDateString('de-DE')}\n`;
            summary += `Erstellt: ${now.toLocaleString('de-DE')}\n\n`;
            
            storageKeys.forEach(key => {
                try {
                    const archive = JSON.parse(localStorage.getItem(key) || '[]');
                    const thisWeek = archive.filter(check => {
                        if (!check.meta || !check.meta.datum) return false;
                        const checkDate = new Date(check.meta.datum);
                        return checkDate >= weekStart && checkDate <= weekEnd;
                    });
                    
                    if (thisWeek.length > 0) {
                        summary += `${typeNames[key]}: ${thisWeek.length}\n`;
                        thisWeek.forEach(check => {
                            summary += `  • ${check.meta.datum} - ${check.meta.mitarbeiter || check.meta.user}\n`;
                        });
                        summary += '\n';
                        weeklyChecks = weeklyChecks.concat(thisWeek);
                    }
                } catch (e) {}
            });
            
            if (weeklyChecks.length === 0) {
                alert('Keine Protokolle für diese Woche gefunden.');
                return;
            }
            
            summary += `Gesamt: ${weeklyChecks.length} Protokolle`;
            
            // Create text file for summary
            const blob = new Blob([summary], { type: 'text/plain' });
            const fileName = `Wochenexport_KW${kw}_${now.toISOString().split('T')[0]}.txt`;
            const file = new File([blob], fileName, { type: 'text/plain' });
            
            try {
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({
                        files: [file],
                        title: `Wochenexport KW ${kw}`,
                        text: summary
                    });
                } else {
                    // Fallback
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('Export wurde heruntergeladen.\n\nBitte in Teams/OneDrive hochladen.');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    alert('Export:\n\n' + summary);
                }
            }
        }
        
        async function shareArchivedCheck() {
            if (!currentArchivedCheck) {
                alert('Kein Protokoll ausgewählt.');
                return;
            }
            
            const check = currentArchivedCheck.check;
            const type = currentArchivedCheck.type;
            const meta = check.meta;
            
            let typeName;
            if (type === 'ambulanz') typeName = 'Ambulanzcheck';
            else if (type === 'mpg') typeName = 'MPG-Check RTW';
            else if (type === 'wochen') typeName = 'RTW Wochencheck';
            else if (type === 'reinigung') typeName = 'Reinigungsplan';
            
            const dateStr = meta.datum || new Date().toLocaleDateString('de-DE');
            const fileName = `${typeName.replace(/\s+/g, '_')}_${dateStr.replace(/\./g, '-')}_${(meta.mitarbeiter || meta.user || 'Unbekannt').replace(/\s+/g, '_')}.pdf`;
            
            // Create summary text
            const summary = `${typeName}\nDatum: ${dateStr}\nMitarbeiter: ${meta.mitarbeiter || meta.user}\nStandort: ${meta.standort}`;
            
            // For archived checks, we need to regenerate or use stored data
            // Simplified: just share the info and prompt to export PDF
            try {
                if (navigator.share) {
                    await navigator.share({
                        title: `${typeName} - ${dateStr}`,
                        text: summary + '\n\nBitte das PDF aus dem Archiv exportieren und in Teams/OneDrive ablegen.'
                    });
                } else {
                    alert(summary + '\n\nBitte das PDF exportieren und in Teams/OneDrive ablegen.');
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    alert('Bitte das PDF exportieren und manuell in Teams/OneDrive ablegen.');
                }
            }
        }

        // INIT
        function initApp() {
            // Setup modal close handlers
            document.getElementById('detailModal').addEventListener('click', e => { 
                if (e.target.id === 'detailModal') e.target.classList.remove('active'); 
            });
            document.getElementById('infoModal').addEventListener('click', e => { 
                if (e.target.id === 'infoModal') e.target.classList.remove('active'); 
            });
            document.getElementById('signModal').addEventListener('click', e => { 
                if (e.target.id === 'signModal') closeSignModal(); 
            });
            
            // Setup session timeout activity listeners
            setupActivityListeners();
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(() => {});
            }
            
            // Log app start
            addAuditEntry('APP_GESTARTET', 'MBWD App geöffnet');
        }
        
        initApp();
    </script>
</body>
</html>
